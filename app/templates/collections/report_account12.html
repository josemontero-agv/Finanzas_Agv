{% extends "base.html" %}

{% block title %}Reporte Cuenta 12 - Dream Stack{% endblock %}

{% block content %}
<div x-data="reportController()" x-init="init()">
    <!-- Header -->
    <div class="flex justify-between items-center pb-4 mb-4 border-b">
        <h1 class="text-2xl font-bold text-gray-800">
            <i class="bi bi-file-earmark-text text-primary"></i>
            Reporte Cuenta 12 - Cuentas por Cobrar
        </h1>
        <div class="space-x-2">
            <button @click="exportToExcel()" 
                    class="btn btn-sm btn-success"
                    :disabled="loading">
                <i class="bi bi-file-earmark-excel"></i> Exportar Excel
            </button>
            <button @click="refreshData()" 
                    class="btn btn-sm btn-primary"
                    :disabled="loading">
                <i class="bi" :class="loading ? 'bi-hourglass-split' : 'bi-arrow-clockwise'"></i>
                <span x-text="loading ? 'Cargando...' : 'Actualizar'"></span>
            </button>
        </div>
    </div>

    <!-- Filtros con Alpine.js -->
    <div class="bg-white rounded-lg shadow-sm p-4 mb-4">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Fecha Desde</label>
                <input type="date" 
                       x-model="filters.date_from"
                       class="form-control">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Fecha Hasta</label>
                <input type="date" 
                       x-model="filters.date_to"
                       class="form-control">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Cliente</label>
                <input type="text" 
                       x-model="filters.customer"
                       placeholder="Buscar cliente..."
                       class="form-control">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Canal de Venta</label>
                <select x-model="filters.sales_channel_id" class="form-select">
                    <option value="">Todos</option>
                    <template x-for="channel in salesChannels" :key="channel.id">
                        <option :value="channel.id" x-text="channel.name"></option>
                    </template>
                </select>
            </div>
        </div>
        <div class="mt-4 flex gap-2">
            <button @click="applyFilters()" class="btn btn-primary">
                <i class="bi bi-search"></i> Buscar
            </button>
            <button @click="resetFilters()" class="btn btn-secondary">
                <i class="bi bi-x-circle"></i> Limpiar
            </button>
        </div>
    </div>

    <!-- KPIs con Alpine.js (reactivos) -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
        <div class="bg-white rounded-lg shadow-sm p-4">
            <h6 class="text-gray-500 text-sm font-medium mb-2">Total Registros</h6>
            <h4 class="text-2xl font-bold text-gray-800" x-text="stats.count"></h4>
        </div>
        <div class="bg-white rounded-lg shadow-sm p-4">
            <h6 class="text-gray-500 text-sm font-medium mb-2">Monto Total</h6>
            <h4 class="text-2xl font-bold text-blue-600" x-text="formatCurrency(stats.total)"></h4>
        </div>
        <div class="bg-white rounded-lg shadow-sm p-4">
            <h6 class="text-gray-500 text-sm font-medium mb-2">Saldo Pendiente</h6>
            <h4 class="text-2xl font-bold text-yellow-600" x-text="formatCurrency(stats.pending)"></h4>
        </div>
        <div class="bg-white rounded-lg shadow-sm p-4">
            <h6 class="text-gray-500 text-sm font-medium mb-2">Deuda Vencida</h6>
            <h4 class="text-2xl font-bold text-red-600" x-text="formatCurrency(stats.overdue)"></h4>
        </div>
    </div>

    <!-- Tabla con HTMX Lazy Loading -->
    <div class="bg-white rounded-lg shadow-sm overflow-hidden">
        <div class="overflow-x-auto" style="max-height: 600px;">
            <table class="w-full text-sm">
                <thead class="bg-primary text-white sticky top-0 z-10">
                    <tr>
                        <th class="px-3 py-3 text-left font-semibold">Estado Pago</th>
                        <th class="px-3 py-3 text-left font-semibold">F. Emisión</th>
                        <th class="px-3 py-3 text-left font-semibold">Tipo Doc</th>
                        <th class="px-3 py-3 text-left font-semibold">Factura</th>
                        <th class="px-3 py-3 text-left font-semibold">Origen</th>
                        <th class="px-3 py-3 text-left font-semibold">Cta. Código</th>
                        <th class="px-3 py-3 text-left font-semibold">Cta. Nombre</th>
                        <th class="px-3 py-3 text-left font-semibold">RUC/DNI</th>
                        <th class="px-3 py-3 text-left font-semibold">Cliente</th>
                        <th class="px-3 py-3 text-left font-semibold">Departamento</th>
                        <th class="px-3 py-3 text-left font-semibold">Distrito</th>
                        <th class="px-3 py-3 text-left font-semibold">País Código</th>
                        <th class="px-3 py-3 text-left font-semibold">País</th>
                        <th class="px-3 py-3 text-left font-semibold">Moneda</th>
                        <th class="px-3 py-3 text-right font-semibold">Monto Total</th>
                        <th class="px-3 py-3 text-right font-semibold">Saldo c/ Ret.</th>
                        <th class="px-3 py-3 text-right font-semibold">Importe</th>
                        <th class="px-3 py-3 text-right font-semibold">Saldo</th>
                        <th class="px-3 py-3 text-left font-semibold">F. Contable</th>
                        <th class="px-3 py-3 text-left font-semibold">F. Vencimiento</th>
                        <th class="px-3 py-3 text-left font-semibold">F. Venc. Fact</th>
                        <th class="px-3 py-3 text-left font-semibold">Referencia</th>
                        <th class="px-3 py-3 text-left font-semibold">Cond. Pago</th>
                        <th class="px-3 py-3 text-left font-semibold">Concepto</th>
                        <th class="px-3 py-3 text-left font-semibold">Vendedor</th>
                        <th class="px-3 py-3 text-left font-semibold">Canal</th>
                        <th class="px-3 py-3 text-left font-semibold">Tipo Venta</th>
                        <th class="px-3 py-3 text-left font-semibold">Est. Pago Mov</th>
                        <th class="px-3 py-3 text-left font-semibold">Grupo/Cadena</th>
                        <th class="px-3 py-3 text-left font-semibold">Sub Canal</th>
                        <th class="px-3 py-3 text-center font-semibold">Días Vencido</th>
                        <th class="px-3 py-3 text-center font-semibold">Estado</th>
                        <th class="px-3 py-3 text-left font-semibold">Antigüedad</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    <!-- Filas se cargarán aquí vía JavaScript -->
                </tbody>
            </table>
        </div>
        
        <!-- Loading indicator -->
        <div id="loading-spinner" 
             x-show="loading"
             class="flex justify-center items-center py-8"
             style="display: none;">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
        </div>
        
        <!-- Infinite scroll trigger -->
        <div id="infinite-scroll-trigger" 
             class="text-center py-2 text-gray-400"
             style="height: 20px;">
            <span x-show="hasMore" class="text-sm">Cargando más resultados...</span>
        </div>
    </div>
</div>

<!-- Alpine.js Controller -->
<script>
function reportController() {
    return {
        loading: false,
        currentPage: 1,
        hasMore: true,
        isLoadingMore: false,
        filters: {
            date_from: '',
            date_to: '',
            customer: '',
            account_codes: '122,1212,123,1312,132',
            sales_channel_id: ''
        },
        stats: {
            count: 0,
            total: 0,
            pending: 0,
            overdue: 0
        },
        salesChannels: [],
        
        async init() {
            await this.loadSalesChannels();
            this.setupIntersectionObserver();
            // Cargar stats y primera página en paralelo
            await Promise.all([
                this.loadStats(),
                this.loadPage(1)
            ]);
        },
        
        setupIntersectionObserver() {
            // Observer para scroll infinito
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting && this.hasMore && !this.isLoadingMore) {
                        this.loadNextPage();
                    }
                });
            }, {
                rootMargin: '100px' // Cargar 100px antes de llegar al final
            });
            
            // Observar el trigger
            const trigger = document.getElementById('infinite-scroll-trigger');
            if (trigger) {
                observer.observe(trigger);
            }
        },
        
        async loadPage(page) {
            if (this.isLoadingMore && page > 1) return;
            
            try {
                this.loading = page === 1;
                this.isLoadingMore = page > 1;
                
                // Construir params correctamente (filtrar valores vacíos)
                const params = new URLSearchParams();
                params.set('page', page);
                Object.keys(this.filters).forEach(key => {
                    if (this.filters[key]) {
                        params.set(key, this.filters[key]);
                    }
                });
                
                console.log(`[DEBUG] Cargando página ${page} con filtros:`, Object.fromEntries(params));
                
                const response = await axios.get(`/api/v1/collections/report/account12/rows?${params}`, {
                    headers: {
                        'Accept': 'text/html'
                    }
                });
                
                if (response.status === 200) {
                    let html = response.data;
                    const tableBody = document.getElementById('table-body');
                    
                    // Verificar si hay más páginas (buscar comentario en la respuesta)
                    if (html.includes('<!-- NO_MORE_DATA -->')) {
                        this.hasMore = false;
                        // Remover el comentario antes de insertar
                        html = html.replace('<!-- NO_MORE_DATA -->', '');
                    } else {
                        this.hasMore = true;
                    }
                    
                    if (page === 1) {
                        // Primera página: reemplazar contenido
                        tableBody.innerHTML = html;
                    } else {
                        // Páginas siguientes: agregar al final
                        tableBody.insertAdjacentHTML('beforeend', html);
                    }
                    
                    this.currentPage = page;
                    console.log(`[DEBUG] Página ${page} cargada: ${tableBody.children.length} filas totales, hasMore=${this.hasMore}`);
                }
            } catch (error) {
                console.error('Error cargando página:', error);
                showToast('Error cargando datos: ' + (error.response?.data || error.message), 'error');
                
                // Mostrar error en la tabla
                const tableBody = document.getElementById('table-body');
                if (tableBody.children.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="33" class="text-center text-red-600 py-4">
                                Error: ${error.response?.data || error.message}
                            </td>
                        </tr>
                    `;
                }
            } finally {
                this.loading = false;
                this.isLoadingMore = false;
            }
        },
        
        async loadNextPage() {
            if (this.hasMore && !this.isLoadingMore) {
                await this.loadPage(this.currentPage + 1);
            }
        },
        
        async loadSalesChannels() {
            try {
                const { data } = await axios.get('/api/v1/collections/filter-options');
                if (data.success) {
                    this.salesChannels = data.data.sales_channels;
                }
            } catch (error) {
                console.error('Error loading channels:', error);
            }
        },
        
        // ✅ Nuevo método para cargar stats desde endpoint optimizado
        async loadStats() {
            try {
                // Construir params correctamente (filtrar valores vacíos)
                const params = new URLSearchParams();
                Object.keys(this.filters).forEach(key => {
                    if (this.filters[key] && this.filters[key] !== '') {
                        params.set(key, this.filters[key]);
                    }
                });
                
                console.log('[DEBUG] Cargando stats con filtros:', Object.fromEntries(params));
                
                const response = await axios.get(`/api/v1/collections/report/account12/stats?${params}`);
                
                console.log('[DEBUG] Respuesta stats:', response.data);
                
                if (response.data && response.data.success) {
                    const statsData = response.data.data || {};
                    this.stats = {
                        count: statsData.total_count || 0,
                        total: statsData.total_amount || 0,
                        pending: statsData.pending_amount || 0,
                        overdue: statsData.overdue_amount || 0
                    };
                    console.log('[DEBUG] Stats actualizados:', this.stats);
                } else {
                    console.warn('[WARN] Respuesta stats sin success:', response.data);
                    // Inicializar con valores por defecto
                    this.stats = {
                        count: 0,
                        total: 0,
                        pending: 0,
                        overdue: 0
                    };
                }
            } catch (error) {
                console.error('[ERROR] Error loading stats:', error);
                console.error('[ERROR] Detalles:', {
                    message: error.message,
                    response: error.response?.data,
                    status: error.response?.status
                });
                showToast('Error cargando estadísticas: ' + (error.response?.data?.message || error.message), 'error');
                // Inicializar con valores por defecto en caso de error
                this.stats = {
                    count: 0,
                    total: 0,
                    pending: 0,
                    overdue: 0
                };
            }
        },
        
        
        async applyFilters() {
            // Resetear estado
            this.currentPage = 1;
            this.hasMore = true;
            document.getElementById('table-body').innerHTML = '';
            
            // Recargar stats y datos en paralelo
            await Promise.all([
                this.loadStats(),
                this.loadPage(1)
            ]);
        },
        
        resetFilters() {
            this.filters = {
                date_from: '',
                date_to: '',
                customer: '',
                account_codes: '122,1212,123,1312,132',
                sales_channel_id: ''
            };
            this.applyFilters();
        },
        
        async refreshData() {
            await this.applyFilters();
        },
        
        async exportToExcel() {
            this.loading = true;
            try {
                const params = new URLSearchParams(this.filters);
                window.location.href = `/api/v1/exports/collections/excel?${params}`;
                showToast('Exportación iniciada', 'success');
            } catch (error) {
                showToast('Error al exportar', 'error');
            } finally {
                this.loading = false;
            }
        },
        
        formatCurrency(value) {
            return window.formatCurrency(value);
        }
    }
}
</script>
{% endblock %}

{% block extra_css %}
<style>
    /* Animaciones HTMX */
    .htmx-swapping {
        opacity: 0;
        transition: opacity 200ms ease-out;
    }

    .htmx-settling {
        opacity: 1;
    }

    /* Loading spinner custom */
    .htmx-indicator {
        display: none;
    }

    .htmx-request .htmx-indicator {
        display: flex;
    }

    /* Skeleton loader para primera carga */
    @keyframes shimmer {
        0% { background-position: -1000px 0; }
        100% { background-position: 1000px 0; }
    }

    .skeleton-row {
        height: 40px;
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 1000px 100%;
        animation: shimmer 2s infinite;
    }

    /* Smooth scroll */
    .overflow-x-auto {
        scroll-behavior: smooth;
    }

    /* Tailwind + Bootstrap compatibility */
    .btn {
        @apply px-4 py-2 rounded font-medium transition-colors;
    }

    .btn-primary {
        @apply bg-primary hover:bg-opacity-90 text-white;
    }

    .form-control {
        @apply w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-primary focus:border-transparent;
    }
</style>
{% endblock %}
