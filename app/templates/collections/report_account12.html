{% extends "base.html" %}

{% block title %}Reporte Cuenta 12 - Dream Stack{% endblock %}

{% block content %}
<div x-data="reportController()" x-init="init()" class="w-full" style="max-width: 100%; overflow-x: hidden;">
    <!-- Header -->
    <div class="flex justify-between items-center pb-4 mb-4 border-b border-gray-200" style="max-width: 100%;">
        <h1 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
            <i class="bi bi-file-earmark-text text-primary"></i>
            Reporte Cuenta 12 - Cuentas por Cobrar
        </h1>
        <div class="flex gap-2">
            <button @click="exportToExcel()" 
                    class="inline-flex items-center justify-center w-10 h-10 rounded-lg bg-green-600 hover:bg-green-700 text-white transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                    :disabled="loading"
                    title="Exportar a Excel">
                <i class="bi bi-file-earmark-excel text-lg"></i>
            </button>
            <button @click="refreshData()" 
                    class="inline-flex items-center justify-center w-10 h-10 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                    :class="loading ? 'bg-gray-400' : 'bg-primary hover:bg-primary-hover'"
                    style="background-color: var(--primary-color);"
                    :disabled="loading"
                    title="Actualizar datos">
                <i class="bi text-lg text-white" :class="loading ? 'bi-hourglass-split animate-spin' : 'bi-arrow-clockwise'"></i>
            </button>
        </div>
    </div>

    <!-- Filtros con Alpine.js -->
    <div class="bg-white rounded-lg shadow-sm p-4 mb-4">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Fecha Desde</label>
                <input type="date" 
                       x-model="filters.date_from"
                       class="form-control">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Fecha Hasta</label>
                <input type="date" 
                       x-model="filters.date_to"
                       class="form-control">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Cliente</label>
                <input type="text" 
                       x-model="filters.customer"
                       placeholder="Buscar cliente..."
                       class="form-control">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Cuenta Contable (Códigos)</label>
                <input type="text" 
                       x-model="filters.account_codes_text"
                       placeholder="Ej: 122,1212,123 o 122"
                       class="form-control"
                       title="Ingrese códigos de cuenta separados por comas sin espacios">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Canal de Venta</label>
                <select x-model="filters.sales_channel_id" class="form-select">
                    <option value="">Todos</option>
                    <template x-for="channel in salesChannels" :key="channel.id">
                        <option :value="channel.id" x-text="channel.name"></option>
                    </template>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Tipo Documento</label>
                <select x-model="filters.doc_type_id" class="form-select">
                    <option value="">Todos</option>
                    <template x-for="type in documentTypes" :key="type.id">
                        <option :value="type.id" x-text="type.name"></option>
                    </template>
                </select>
            </div>
        </div>
        <div class="mt-4 flex gap-2">
            <button @click="applyFilters()" 
                    class="inline-flex items-center justify-center px-4 py-2 rounded-lg text-white font-medium transition-colors"
                    style="background-color: var(--primary-color);"
                    :disabled="loading"
                    title="Buscar">
                <i class="bi bi-search mr-2"></i> Buscar
            </button>
            <button @click="resetFilters()" 
                    class="inline-flex items-center justify-center px-4 py-2 rounded-lg bg-gray-500 hover:bg-gray-600 text-white font-medium transition-colors"
                    :disabled="loading"
                    title="Limpiar filtros">
                <i class="bi bi-x-circle mr-2"></i> Limpiar
            </button>
        </div>
    </div>

    <!-- KPI Summary Ribbon - Compact Enterprise Style -->
    <div class="bg-white rounded-lg shadow-sm mb-4 overflow-hidden">
        <div class="flex items-stretch divide-x divide-gray-200">
            <!-- Total Registros -->
            <div class="flex-1 px-6 py-3 hover:bg-gray-50 transition-colors">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">Total Registros</p>
                        <p class="text-xl font-bold text-gray-800" x-text="stats.count">0</p>
                    </div>
                    <i class="bi bi-list-check text-2xl text-gray-400"></i>
                </div>
            </div>
            
            <!-- Monto Total -->
            <div class="flex-1 px-6 py-3 hover:bg-blue-50 transition-colors">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs font-medium text-blue-600 uppercase tracking-wide mb-1">Monto Total</p>
                        <p class="text-xl font-bold text-blue-600" x-text="formatCurrency(stats.total)">S/ 0.00</p>
                    </div>
                    <i class="bi bi-cash-stack text-2xl text-blue-400"></i>
                </div>
            </div>
            
            <!-- Saldo Pendiente -->
            <div class="flex-1 px-6 py-3 hover:bg-yellow-50 transition-colors">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs font-medium text-yellow-600 uppercase tracking-wide mb-1">Saldo Pendiente</p>
                        <p class="text-xl font-bold text-yellow-600" x-text="formatCurrency(stats.pending)">S/ 0.00</p>
                    </div>
                    <i class="bi bi-clock-history text-2xl text-yellow-400"></i>
                </div>
            </div>
            
            <!-- Deuda Vencida -->
            <div class="flex-1 px-6 py-3 hover:bg-red-50 transition-colors">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs font-medium text-red-600 uppercase tracking-wide mb-1">Deuda Vencida</p>
                        <p class="text-xl font-bold text-red-600" x-text="formatCurrency(stats.overdue)">S/ 0.00</p>
                    </div>
                    <i class="bi bi-exclamation-triangle text-2xl text-red-400"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla con HTMX Lazy Loading -->
    <div class="bg-white rounded-lg shadow-sm overflow-hidden" style="max-width: 100%; width: 100%;">
        <div class="overflow-x-auto overflow-y-auto" style="max-height: 75vh; scroll-behavior: smooth; width: 100%;">
            <table class="text-sm" style="width: max-content; min-width: 100%;">
                <thead class="text-white sticky top-0 z-10" style="background-color: var(--primary-color);">
                    <tr>
                        <th class="px-3 py-3 text-left font-semibold whitespace-nowrap">Fecha Factura</th>
                        <th class="px-3 py-3 text-left font-semibold whitespace-nowrap">Fecha Contabilización</th>
                        <th class="px-3 py-3 text-left font-semibold whitespace-nowrap">Tipo Documento</th>
                        <th class="px-3 py-3 text-left font-semibold whitespace-nowrap">Número Documento</th>
                        <th class="px-3 py-3 text-left font-semibold whitespace-nowrap">Origen</th>
                        <th class="px-3 py-3 text-left font-semibold whitespace-nowrap">Cuenta</th>
                        <th class="px-3 py-3 text-left font-semibold whitespace-nowrap">Nombre Cuenta</th>
                        <th class="px-3 py-3 text-left font-semibold whitespace-nowrap">RUC/DNI</th>
                        <th class="px-3 py-3 text-left font-semibold whitespace-nowrap">Cliente</th>
                        <th class="px-3 py-3 text-left font-semibold whitespace-nowrap">Moneda</th>
                        <th class="px-3 py-3 text-right font-semibold whitespace-nowrap">Total Moneda Origen</th>
                        <th class="px-3 py-3 text-right font-semibold whitespace-nowrap">Adeudado</th>
                        <th class="px-3 py-3 text-right font-semibold whitespace-nowrap">Adeudado S/.</th>
                        <th class="px-3 py-3 text-left font-semibold whitespace-nowrap">Fecha Vencimiento</th>
                        <th class="px-3 py-3 text-center font-semibold whitespace-nowrap">Días Vencido</th>
                        <th class="px-3 py-3 text-center font-semibold whitespace-nowrap">Estado</th>
                        <th class="px-3 py-3 text-left font-semibold whitespace-nowrap">Antigüedad</th>
                        <th class="px-3 py-3 text-left font-semibold whitespace-nowrap">Referencia</th>
                        <th class="px-3 py-3 text-left font-semibold whitespace-nowrap">Condición Pago</th>
                        <th class="px-3 py-3 text-left font-semibold whitespace-nowrap">Descripción</th>
                        <th class="px-3 py-3 text-left font-semibold whitespace-nowrap">Vendedor</th>
                        <th class="px-3 py-3 text-left font-semibold whitespace-nowrap">Provincia</th>
                        <th class="px-3 py-3 text-left font-semibold whitespace-nowrap">Distrito</th>
                        <th class="px-3 py-3 text-left font-semibold whitespace-nowrap">Código País</th>
                        <th class="px-3 py-3 text-left font-semibold whitespace-nowrap">País</th>
                        <th class="px-3 py-3 text-left font-semibold whitespace-nowrap">Grupos</th>
                        <th class="px-3 py-3 text-left font-semibold whitespace-nowrap">Sub Canal</th>
                        <th class="px-3 py-3 text-left font-semibold whitespace-nowrap">Canal de Venta</th>
                        <th class="px-3 py-3 text-left font-semibold whitespace-nowrap">Tipo de Venta</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    <!-- Filas se cargarán aquí vía JavaScript -->
                </tbody>
            </table>
        </div>
        
        <!-- Loading indicator -->
        <div id="loading-spinner" 
             x-show="loading"
             class="flex justify-center items-center py-8"
             style="display: none;">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
        </div>
        
        <!-- Infinite scroll trigger -->
        <div id="infinite-scroll-trigger" 
             class="text-center py-2 text-gray-400"
             style="height: 20px;">
            <span x-show="hasMore" class="text-sm">Cargando más resultados...</span>
        </div>
    </div>
</div>

<!-- Alpine.js Controller -->
<script>
function reportController() {
    return {
        loading: false,
        currentPage: 1,
        hasMore: true,
        isLoadingMore: false,
        filters: {
            date_from: '',
            date_to: '',
            customer: '',
            account_codes_text: '122,1212,123,1312,132',
            sales_channel_id: '',
            doc_type_id: ''
        },
        stats: {
            count: 0,
            total: 0,
            pending: 0,
            overdue: 0
        },
        salesChannels: [],
        documentTypes: [],
        
        async init() {
            await this.loadFilterOptions();
            this.setupIntersectionObserver();
            // Cargar stats y primera página en paralelo
            await Promise.all([
                this.loadStats(),
                this.loadPage(1)
            ]);
        },
        
        // Procesar el texto de códigos de cuenta (convertir a formato API)
        getAccountCodesForAPI() {
            const text = this.filters.account_codes_text.trim();
            if (!text) return '';
            // Limpiar espacios alrededor de comas y retornar
            return text.split(',').map(code => code.trim()).filter(code => code).join(',');
        },
        
        setupIntersectionObserver() {
            // Observer para scroll infinito
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting && this.hasMore && !this.isLoadingMore) {
                        this.loadNextPage();
                    }
                });
            }, {
                rootMargin: '100px' // Cargar 100px antes de llegar al final
            });
            
            // Observar el trigger
            const trigger = document.getElementById('infinite-scroll-trigger');
            if (trigger) {
                observer.observe(trigger);
            }
        },
        
        async loadPage(page) {
            if (this.isLoadingMore && page > 1) return;
            
            try {
                this.loading = page === 1;
                this.isLoadingMore = page > 1;
                
                // Construir params correctamente (filtrar valores vacíos)
                const params = new URLSearchParams();
                params.set('page', page);
                Object.keys(this.filters).forEach(key => {
                    let value = this.filters[key];
                    
                    // Procesamiento especial para account_codes_text
                    if (key === 'account_codes_text') {
                        value = this.getAccountCodesForAPI();
                        key = 'account_codes'; // Cambiar el nombre de la clave
                    }
                    
                    if (value) {
                        params.set(key, value);
                    }
                });
                
                console.log(`[DEBUG] Cargando página ${page} con filtros:`, Object.fromEntries(params));
                
                const response = await axios.get(`/api/v1/collections/report/account12/rows?${params}`, {
                    headers: {
                        'Accept': 'text/html'
                    }
                });
                
                if (response.status === 200) {
                    let html = response.data;
                    const tableBody = document.getElementById('table-body');
                    
                    // Verificar si hay más páginas (buscar comentario en la respuesta)
                    if (html.includes('<!-- NO_MORE_DATA -->')) {
                        this.hasMore = false;
                        // Remover el comentario antes de insertar
                        html = html.replace('<!-- NO_MORE_DATA -->', '');
                    } else {
                        this.hasMore = true;
                    }
                    
                    if (page === 1) {
                        // Primera página: reemplazar contenido
                        tableBody.innerHTML = html;
                    } else {
                        // Páginas siguientes: agregar al final
                        tableBody.insertAdjacentHTML('beforeend', html);
                    }
                    
                    this.currentPage = page;
                    console.log(`[DEBUG] Página ${page} cargada: ${tableBody.children.length} filas totales, hasMore=${this.hasMore}`);
                }
            } catch (error) {
                console.error('Error cargando página:', error);
                showToast('Error cargando datos: ' + (error.response?.data || error.message), 'error');
                
                // Mostrar error en la tabla
                const tableBody = document.getElementById('table-body');
                if (tableBody.children.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="33" class="text-center text-red-600 py-4">
                                Error: ${error.response?.data || error.message}
                            </td>
                        </tr>
                    `;
                }
            } finally {
                this.loading = false;
                this.isLoadingMore = false;
            }
        },
        
        async loadNextPage() {
            if (this.hasMore && !this.isLoadingMore) {
                await this.loadPage(this.currentPage + 1);
            }
        },
        
        async loadFilterOptions() {
            try {
                const { data } = await axios.get('/api/v1/collections/filter-options');
                if (data.success) {
                    this.salesChannels = data.data.sales_channels;
                    this.documentTypes = data.data.document_types;
                }
            } catch (error) {
                console.error('Error loading filter options:', error);
            }
        },
        
        // ✅ Nuevo método para cargar stats desde endpoint optimizado
        async loadStats() {
            try {
                // Construir params correctamente (filtrar valores vacíos)
                const params = new URLSearchParams();
                Object.keys(this.filters).forEach(key => {
                    let value = this.filters[key];
                    
                    // Procesamiento especial para account_codes_text
                    if (key === 'account_codes_text') {
                        value = this.getAccountCodesForAPI();
                        key = 'account_codes'; // Cambiar el nombre de la clave
                    }
                    
                    if (value && value !== '') {
                        params.set(key, value);
                    }
                });
                
                console.log('[DEBUG] Cargando stats con filtros:', Object.fromEntries(params));
                
                const response = await axios.get(`/api/v1/collections/report/account12/stats?${params}`);
                
                console.log('[DEBUG] Respuesta stats:', response.data);
                
                if (response.data && response.data.success) {
                    const statsData = response.data.data || {};
                    this.stats = {
                        count: statsData.total_count || 0,
                        total: statsData.total_amount || 0,
                        pending: statsData.pending_amount || 0,
                        overdue: statsData.overdue_amount || 0
                    };
                    console.log('[DEBUG] Stats actualizados:', this.stats);
                } else {
                    console.warn('[WARN] Respuesta stats sin success:', response.data);
                    // Inicializar con valores por defecto
                    this.stats = {
                        count: 0,
                        total: 0,
                        pending: 0,
                        overdue: 0
                    };
                }
            } catch (error) {
                console.error('[ERROR] Error loading stats:', error);
                console.error('[ERROR] Detalles:', {
                    message: error.message,
                    response: error.response?.data,
                    status: error.response?.status
                });
                showToast('Error cargando estadísticas: ' + (error.response?.data?.message || error.message), 'error');
                // Inicializar con valores por defecto en caso de error
                this.stats = {
                    count: 0,
                    total: 0,
                    pending: 0,
                    overdue: 0
                };
            }
        },
        
        
        async applyFilters() {
            // Resetear estado
            this.currentPage = 1;
            this.hasMore = true;
            document.getElementById('table-body').innerHTML = '';
            
            // Recargar stats y datos en paralelo
            await Promise.all([
                this.loadStats(),
                this.loadPage(1)
            ]);
        },
        
        resetFilters() {
            this.filters = {
                date_from: '',
                date_to: '',
                customer: '',
                account_codes_text: '122,1212,123,1312,132',
                sales_channel_id: '',
                doc_type_id: ''
            };
            this.applyFilters();
        },
        
        async refreshData() {
            await this.applyFilters();
        },
        
        async exportToExcel() {
            this.loading = true;
            try {
                const params = new URLSearchParams();
                Object.keys(this.filters).forEach(key => {
                    let value = this.filters[key];
                    
                    // Procesamiento especial para account_codes_text
                    if (key === 'account_codes_text') {
                        value = this.getAccountCodesForAPI();
                        key = 'account_codes'; // Cambiar el nombre de la clave
                    }
                    
                    if (value) {
                        params.set(key, value);
                    }
                });
                window.location.href = `/api/v1/exports/collections/excel?${params}`;
                showToast('Exportación iniciada', 'success');
            } catch (error) {
                showToast('Error al exportar', 'error');
            } finally {
                this.loading = false;
            }
        },
        
        formatCurrency(value) {
            return window.formatCurrency(value);
        }
    }
}
</script>
{% endblock %}

{% block extra_css %}
<style>
    /* Animaciones HTMX */
    .htmx-swapping {
        opacity: 0;
        transition: opacity 200ms ease-out;
    }

    .htmx-settling {
        opacity: 1;
    }

    /* Loading spinner custom */
    .htmx-indicator {
        display: none;
    }

    .htmx-request .htmx-indicator {
        display: flex;
    }

    /* Skeleton loader para primera carga */
    @keyframes shimmer {
        0% { background-position: -1000px 0; }
        100% { background-position: 1000px 0; }
    }

    .skeleton-row {
        height: 40px;
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 1000px 100%;
        animation: shimmer 2s infinite;
    }

    /* Estilos para celdas truncadas que se expanden al pasar el mouse */
    .cell-truncate {
        max-width: 120px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        transition: all 0.2s ease;
        cursor: help;
    }
    
    .cell-truncate:hover {
        white-space: normal;
        overflow: visible;
        word-wrap: break-word;
        position: relative;
        z-index: 20;
        /* Opcional: si queremos que flote sobre otros elementos */
        /* background-color: white; */
        /* box-shadow: 0 2px 4px rgba(0,0,0,0.1); */
    }

    /* Tailwind + Bootstrap compatibility */
    .btn {
        @apply px-4 py-2 rounded font-medium transition-colors;
    }

    .btn-primary {
        @apply text-white;
        background-color: var(--primary-color);
    }

    .btn-primary:hover {
        background-color: var(--primary-hover);
    }

    .form-control {
        @apply w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-primary focus:border-transparent;
    }

    /* Evitar scroll horizontal en la página */
    * {
        box-sizing: border-box;
    }
    
    /* Asegurar que los contenedores no excedan el ancho de la pantalla */
    .bg-white.rounded-lg {
        max-width: 100%;
        overflow-x: hidden;
    }
    
    /* Responsive improvements */
    @media (max-width: 768px) {
        .flex.justify-between.items-center {
            flex-direction: column;
            gap: 1rem;
            align-items: flex-start;
        }
        
        .flex.gap-2 {
            width: 100%;
            justify-content: flex-start;
        }
        
        /* KPI Ribbon en móvil */
        .flex.items-stretch.divide-x {
            flex-direction: column;
            divide-x: 0;
        }
        
        .flex.items-stretch.divide-x > div {
            border-right: none !important;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .flex.items-stretch.divide-x > div:last-child {
            border-bottom: none;
        }
        
        /* Ajustar grid de filtros en móvil */
        .grid.grid-cols-1.md\\:grid-cols-2.lg\\:grid-cols-5 {
            grid-template-columns: 1fr !important;
        }
    }
    
    /* Tablet */
    @media (min-width: 769px) and (max-width: 1024px) {
        .grid.grid-cols-1.md\\:grid-cols-2.lg\\:grid-cols-5 {
            grid-template-columns: repeat(2, 1fr) !important;
        }
    }
    
    /* Desktop */
    @media (min-width: 1025px) {
        .grid.grid-cols-1.md\\:grid-cols-2.lg\\:grid-cols-5 {
            grid-template-columns: repeat(3, 1fr) !important;
        }
    }
    
    /* Desktop grande */
    @media (min-width: 1440px) {
        .grid.grid-cols-1.md\\:grid-cols-2.lg\\:grid-cols-5 {
            grid-template-columns: repeat(5, 1fr) !important;
        }
    }

    /* Truncate cell with hover expansion */
    .truncate-cell {
        max-width: 150px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        transition: all 0.2s ease;
    }
    
    .truncate-cell:hover {
        white-space: normal;
        overflow: visible;
        word-break: break-word;
        position: relative;
        z-index: 50;
        background-color: #fff;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        min-width: 200px; /* Expand width slightly on hover if needed */
        border-radius: 4px;
        padding: 4px;
        margin: -4px; /* Offset padding */
    }
</style>
{% endblock %}
