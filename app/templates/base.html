<!DOCTYPE html>
<html lang="es" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Finanzas AGV{% endblock %} {% if session.username %} | {{ session.username }}{% endif %}</title>
    
    <!-- Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    
    <!-- Custom CSS -->
    <style>
        :root {
            --primary-color: #714B67; /* Color principal Odoo/Agrovet */
            --secondary-color: #875A7B; /* Color secundario Odoo */
            --primary-hover: #5a3a52; /* Color hover más oscuro */
            --bg-light: #f5f7fa;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-light);
            overflow-x: hidden; /* Evitar scroll horizontal en la página */
            overflow-y: auto; /* Solo scroll vertical en la página */
        }

        /* =========================
           Modo oscuro (Bootstrap 5.3 + overrides para utilidades tipo Tailwind)
           ========================= */
        [data-bs-theme="dark"] body {
            background-color: #0b1220; /* fondo principal */
            color: #e5e7eb;
        }

        /* Cards/containers */
        [data-bs-theme="dark"] .card,
        [data-bs-theme="dark"] .bg-white.rounded-lg,
        [data-bs-theme="dark"] .bg-white {
            background-color: #111827 !important; /* gray-900 */
            color: #e5e7eb !important;
        }

        [data-bs-theme="dark"] .border-gray-200 {
            border-color: rgba(255, 255, 255, 0.12) !important;
        }

        [data-bs-theme="dark"] .bg-gray-50 { background-color: rgba(255,255,255,0.03) !important; }
        [data-bs-theme="dark"] .bg-gray-100 { background-color: rgba(255,255,255,0.06) !important; }
        [data-bs-theme="dark"] .bg-gray-200 { background-color: rgba(255,255,255,0.10) !important; }

        [data-bs-theme="dark"] .text-gray-500 { color: #9ca3af !important; }
        [data-bs-theme="dark"] .text-gray-600 { color: #cbd5e1 !important; }
        [data-bs-theme="dark"] .text-gray-700 { color: #e5e7eb !important; }
        [data-bs-theme="dark"] .text-gray-800 { color: #f3f4f6 !important; }
        [data-bs-theme="dark"] .text-gray-900 { color: #f9fafb !important; }

        /* Sidebar en modo oscuro */
        [data-bs-theme="dark"] .sidebar {
            background-color: #0b1220 !important;
            box-shadow: 2px 0 8px rgba(0,0,0,.35);
        }

        [data-bs-theme="dark"] .sidebar .nav-link {
            color: rgba(229,231,235,0.80) !important;
        }

        [data-bs-theme="dark"] .sidebar .nav-link:hover {
            background-color: rgba(255,255,255,0.06);
            color: #ffffff !important;
        }

        [data-bs-theme="dark"] .sidebar .nav-link.active {
            background-color: rgba(113, 75, 103, 0.55);
            color: #ffffff !important;
        }

        [data-bs-theme="dark"] .sidebar .sidebar-heading {
            color: rgba(229,231,235,0.55) !important;
        }

        /* KPI cards (clases tipo Tailwind) en modo oscuro */
        [data-bs-theme="dark"] .bg-blue-50 { background-color: rgba(59,130,246,0.10) !important; }
        [data-bs-theme="dark"] .bg-green-50 { background-color: rgba(34,197,94,0.10) !important; }
        [data-bs-theme="dark"] .bg-purple-50 { background-color: rgba(168,85,247,0.10) !important; }
        [data-bs-theme="dark"] .bg-orange-50 { background-color: rgba(249,115,22,0.10) !important; }
        [data-bs-theme="dark"] .bg-red-50 { background-color: rgba(239,68,68,0.10) !important; }

        [data-bs-theme="dark"] .border-blue-200 { border-color: rgba(59,130,246,0.35) !important; }
        [data-bs-theme="dark"] .border-green-200 { border-color: rgba(34,197,94,0.35) !important; }
        [data-bs-theme="dark"] .border-purple-200 { border-color: rgba(168,85,247,0.35) !important; }
        [data-bs-theme="dark"] .border-orange-200 { border-color: rgba(249,115,22,0.35) !important; }
        [data-bs-theme="dark"] .border-red-200 { border-color: rgba(239,68,68,0.35) !important; }

        [data-bs-theme="dark"] .text-blue-700,
        [data-bs-theme="dark"] .text-green-700,
        [data-bs-theme="dark"] .text-purple-700,
        [data-bs-theme="dark"] .text-orange-700,
        [data-bs-theme="dark"] .text-red-700 {
            color: rgba(229,231,235,0.85) !important;
        }

        [data-bs-theme="dark"] .text-blue-900,
        [data-bs-theme="dark"] .text-green-900,
        [data-bs-theme="dark"] .text-purple-900,
        [data-bs-theme="dark"] .text-orange-900,
        [data-bs-theme="dark"] .text-red-900 {
            color: #f9fafb !important;
        }

        /* Inputs */
        [data-bs-theme="dark"] .form-control,
        [data-bs-theme="dark"] .form-select {
            background-color: rgba(255,255,255,0.06) !important;
            color: #e5e7eb !important;
            border-color: rgba(255,255,255,0.18) !important;
        }

        /* Select nativo (Windows): el menú de opciones no siempre hereda el tema.
           Forzamos paleta oscura para que no quede texto claro sobre fondo blanco. */
        [data-bs-theme="dark"] select,
        [data-bs-theme="dark"] .form-select {
            color-scheme: dark;
        }

        [data-bs-theme="dark"] select option,
        [data-bs-theme="dark"] select optgroup {
            background-color: #111827; /* gray-900 */
            color: #e5e7eb;
        }

        [data-bs-theme="dark"] select option:disabled {
            color: rgba(229,231,235,0.45);
        }

        /* Mejor contraste en la opción seleccionada (si el navegador lo soporta) */
        [data-bs-theme="dark"] select option:checked {
            background-color: rgba(113, 75, 103, 0.70);
            color: #ffffff;
        }

        [data-bs-theme="dark"] .form-control::placeholder {
            color: rgba(229,231,235,0.65) !important;
        }

        /* Tables */
        [data-bs-theme="dark"] .table,
        [data-bs-theme="dark"] table {
            color: #e5e7eb;
        }
        [data-bs-theme="dark"] thead {
            border-color: rgba(255,255,255,0.12);
        }

        /* Fila "seleccionada" / foco en tablas (evita que se ponga blanca en dark) */
        [data-bs-theme="dark"] .table > :not(caption) > * > * {
            border-color: rgba(255,255,255,0.10);
        }

        [data-bs-theme="dark"] .table-active,
        [data-bs-theme="dark"] tr.table-active,
        [data-bs-theme="dark"] tr.active,
        [data-bs-theme="dark"] tr:focus,
        [data-bs-theme="dark"] tr:focus-within,
        [data-bs-theme="dark"] tr[aria-selected="true"],
        [data-bs-theme="dark"] tr.selected {
            background-color: rgba(255, 255, 255, 0.08) !important;
            color: #f9fafb !important;
        }

        [data-bs-theme="dark"] .table-hover tbody tr:hover,
        [data-bs-theme="dark"] tbody tr:hover {
            background-color: rgba(255, 255, 255, 0.06) !important;
        }

        [data-bs-theme="dark"] tr.table-active td,
        [data-bs-theme="dark"] tr.active td,
        [data-bs-theme="dark"] tr:focus td,
        [data-bs-theme="dark"] tr:focus-within td,
        [data-bs-theme="dark"] tr[aria-selected="true"] td,
        [data-bs-theme="dark"] tr.selected td {
            background-color: transparent !important;
            color: inherit !important;
        }

        /* Hover "expand" de celdas truncadas (evitar fondo blanco en modo oscuro) */
        [data-bs-theme="dark"] .truncate-cell:hover,
        [data-bs-theme="dark"] .cell-truncate:hover {
            background-color: #111827 !important; /* gray-900 */
            color: #f9fafb !important;
            box-shadow: 0 8px 20px rgba(0,0,0,0.45) !important;
            border: 1px solid rgba(255,255,255,0.12);
        }

        /* Dropdowns */
        [data-bs-theme="dark"] .dropdown-menu {
            background-color: #111827;
            border-color: rgba(255,255,255,0.12);
        }
        [data-bs-theme="dark"] .dropdown-item {
            color: #e5e7eb;
        }
        [data-bs-theme="dark"] .dropdown-item:hover {
            background-color: rgba(255,255,255,0.08);
        }
        
        .navbar {
            background-color: var(--primary-color) !important;
            box-shadow: 0 2px 4px rgba(0,0,0,.1);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }
        
        body {
            padding-top: 56px;
        }
        
        .user-highlight {
            background: rgba(255, 255, 255, 0.15);
            padding: 6px 14px;
            border-radius: 8px;
            color: #ffffff;
            font-weight: 500;
            font-size: 0.95em;
            border: 1px solid rgba(255, 255, 255, 0.3);
            display: inline-block;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .user-highlight:hover {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.5);
            box-shadow: 0 2px 8px rgba(255, 255, 255, 0.2);
        }
        
        .user-icon {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.2em;
            margin-right: 4px;
            vertical-align: middle;
        }
        
        /* Dropdown de usuario mejorado */
        .user-dropdown {
            min-width: 280px;
            border-radius: 12px;
            border: none;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            padding: 0;
        }
        
        .user-dropdown .dropdown-header {
            background: linear-gradient(135deg, #714B67 0%, #875A7B 100%);
            color: white;
            padding: 0;
            border-radius: 12px 12px 0 0;
        }
        
        .user-info-dropdown {
            display: flex;
            align-items: center;
            padding: 20px;
            gap: 15px;
        }
        
        .user-info-dropdown i {
            flex-shrink: 0;
            color: white !important;
        }
        
        .user-details {
            flex: 1;
            color: white;
        }
        
        .user-details strong {
            font-size: 1.1rem;
            display: block;
            margin-bottom: 4px;
        }
        
        .user-details small {
            font-size: 0.85rem;
            opacity: 0.9;
            color: rgba(255, 255, 255, 0.95) !important;
        }
        
        .user-dropdown .dropdown-item {
            padding: 12px 20px;
            transition: all 0.2s ease;
        }
        
        .user-dropdown .dropdown-item:hover {
            background-color: #f8f9fa;
            color: #714B67;
            padding-left: 24px;
        }
        
        .user-dropdown .dropdown-item i {
            margin-right: 8px;
            width: 20px;
            text-align: center;
        }
        
        .user-dropdown .dropdown-divider {
            margin: 0;
        }
        
        .sidebar {
            min-height: 100vh;
            background-color: #fff;
            box-shadow: 2px 0 5px rgba(0,0,0,.05);
            width: 60px;
            transition: width 0.3s ease;
            overflow-y: auto;
            overflow-x: hidden;
            position: fixed;
            left: 0;
            top: 0;
            z-index: 999;
            padding-top: 56px;
        }
        
        .sidebar:hover {
            width: 250px;
        }
        
        /* Responsive para sidebar */
        @media (max-width: 768px) {
            .sidebar {
                width: 0;
                padding-top: 56px;
            }
            
            .sidebar.show {
                width: 250px;
            }
            
            .main-content-with-sidebar {
                margin-left: 0 !important;
            }
        }
        
        .sidebar .nav-link {
            white-space: nowrap;
        }
        
        .sidebar .nav-link i {
            min-width: 28px;
            display: inline-block;
            text-align: center;
        }
        
        .sidebar .nav-link span {
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .sidebar:hover .nav-link span {
            opacity: 1;
        }
        
        .sidebar .sidebar-heading {
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .sidebar:hover .sidebar-heading {
            opacity: 1;
        }
        
        .main-content-with-sidebar {
            margin-left: 60px;
            transition: margin-left 0.3s ease;
            padding: 20px;
            max-width: calc(100vw - 60px); /* Ancho máximo menos el sidebar */
            width: 100%;
            overflow-x: hidden; /* Sin scroll horizontal en el contenedor principal */
            box-sizing: border-box;
        }
        
        /* Contenedor para limitar ancho de contenido */
        .container-fluid {
            max-width: 1920px;
            margin: 0 auto;
        }
        
        .nav-link {
            color: #6c757d;
            padding: 0.75rem 1rem;
            transition: all 0.3s;
        }
        
        .nav-link:hover {
            background-color: #f8f9fa;
            color: var(--primary-color);
        }
        
        .nav-link.active {
            background-color: var(--primary-color);
            color: white !important;
        }
        
        .card {
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,.08);
            margin-bottom: 1.5rem;
            border-radius: 0.5rem;
        }
        
        .card-header {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            border-radius: 0.5rem 0.5rem 0 0;
        }
        
        /* Mejorar tablas responsivas */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-bottom: 1rem;
        }
        
        .table {
            font-size: 0.9rem;
            margin-bottom: 0;
        }
        
        .table th {
            font-size: 0.85rem;
            white-space: nowrap;
            vertical-align: middle;
        }
        
        .table td {
            vertical-align: middle;
        }
        
        /* Ajustar filtros para pantallas pequeñas */
        @media (max-width: 992px) {
            .filter-form .col-md-2,
            .filter-form .col-md-3 {
                min-width: 100%;
                margin-bottom: 10px;
            }
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-primary:hover {
            background-color: var(--primary-hover);
            border-color: var(--primary-hover);
        }
        
        .table-responsive {
            margin-top: 1rem;
        }
        
        .loading-spinner {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(17, 24, 39, 0.45); /* gray-900 @ 45% */
            backdrop-filter: blur(2px);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }

        .loading-card {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,.2);
            padding: 22px 26px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            min-width: 260px;
            text-align: center;
        }

        .loading-title {
            font-weight: 700;
            color: #374151; /* gray-700 */
        }

        .loading-subtitle {
            color: #6b7280; /* gray-500 */
            font-size: 0.9rem;
        }
    </style>
    
    {% block extra_css %}{% endblock %}
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="{{ url_for('web.dashboard') }}">
                <i class="bi bi-building"></i> Finanzas AGV
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>

            <!-- Acciones siempre visibles (NO dentro del collapse) -->
            {% if session.logged_in %}
            <div class="d-flex align-items-center gap-2 ms-auto">
                <button id="theme-toggle"
                        type="button"
                        class="btn btn-sm btn-outline-light"
                        title="Cambiar modo oscuro">
                    <i id="theme-toggle-icon" class="bi bi-moon-stars"></i>
                </button>

                <a class="nav-link text-white px-2" href="{{ url_for('web.logout') }}" title="Cerrar Sesión">
                    <i class="bi bi-box-arrow-right" style="font-size: 1.3rem;"></i>
                </a>

                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle text-white" href="#" role="button" data-bs-toggle="dropdown">
                        <i class="bi bi-person-circle user-icon"></i>
                        <span class="user-highlight">{{ session.username }}</span>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end user-dropdown">
                        <li class="dropdown-header">
                            <div class="user-info-dropdown">
                                <i class="bi bi-person-circle" style="font-size: 2.5rem; color: #714B67;"></i>
                                <div class="user-details">
                                    <strong>{{ session.username }}</strong>
                                    {% if session.email %}
                                    <small class="text-muted d-block">{{ session.email }}</small>
                                    {% endif %}
                                </div>
                            </div>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <a class="dropdown-item" href="{{ url_for('web.logout') }}">
                                <i class="bi bi-box-arrow-right"></i> Cerrar Sesión
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            {% endif %}

            <!-- Collapse (si en el futuro agregas links arriba) -->
            <div class="collapse navbar-collapse" id="navbarNav"></div>
        </div>
    </nav>

    {% if session.logged_in %}
    <!-- Layout con Sidebar -->
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="d-md-block sidebar p-0">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('web.dashboard') }}">
                                <i class="bi bi-speedometer2"></i> <span>Dashboard</span>
                            </a>
                        </li>
                        
                        <li class="nav-item">
                            <h6 class="sidebar-heading px-3 mt-4 mb-1 text-muted">
                                <span>COBRANZAS</span>
                            </h6>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('web.collections_report_12') }}">
                                <i class="bi bi-file-earmark-text"></i> <span>Reporte Cuenta 12</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('web.collections_report_national') }}">
                                <i class="bi bi-flag"></i> <span>Reporte Nacional</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('web.collections_report_international') }}">
                                <i class="bi bi-globe"></i> <span>Reporte Internacional</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('web.collections_dashboard') }}">
                                <i class="bi bi-bar-chart"></i> <span>Dashboard Cobranzas</span>
                            </a>
                        </li>
                        
                        <li class="nav-item">
                            <h6 class="sidebar-heading px-3 mt-4 mb-1 text-muted">
                                <span>TESORERÍA</span>
                            </h6>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('web.treasury_report_42') }}">
                                <i class="bi bi-file-earmark-text"></i> <span>Reporte Cuenta 42</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('web.treasury_report_daily_payments') }}">
                                <i class="bi bi-calendar-check"></i> <span>Reporte Pagos Diarios</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('web.treasury_report_supplier_banks') }}">
                                <i class="bi bi-bank"></i> <span>Cuentas Bancarias</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('web.treasury_dashboard') }}">
                                <i class="bi bi-bar-chart"></i> <span>Dashboard Tesorería</span>
                            </a>
                        </li>
                        
                        <li class="nav-item">
                            <h6 class="sidebar-heading px-3 mt-4 mb-1 text-muted">
                                <span>LETRAS</span>
                            </h6>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('web.letters_dashboard') }}">
                                <i class="bi bi-speedometer"></i> <span>Dashboard Letras</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('web.letters_management') }}">
                                <i class="bi bi-envelope-paper"></i> <span>Gestión de Envíos</span>
                            </a>
                        </li>

                        <li class="nav-item">
                            <h6 class="sidebar-heading px-3 mt-4 mb-1 text-muted">
                                <span>GESTIÓN</span>
                            </h6>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('web.detractions_send') }}">
                                <i class="bi bi-send"></i> <span>Enviar Detracciones</span>
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Main Content -->
            <main class="main-content-with-sidebar px-md-4 py-4">
                <!-- Flash Messages -->
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}

                <!-- Page Content -->
                {% block content %}{% endblock %}
            </main>
        </div>
    </div>
    {% else %}
    <!-- Content sin sidebar para login -->
    <div class="container">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show mt-3" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        
        {% block content_no_sidebar %}{% endblock %}
    </div>
    {% endif %}

    <!-- Loading Spinner -->
    <div class="loading-spinner">
        <div class="loading-card" role="status" aria-live="polite" aria-busy="true">
            <div class="spinner-border text-primary" role="img" aria-label="Cargando" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <div class="loading-title">Cargando…</div>
            <div class="loading-subtitle">Procesando información, por favor espere</div>
        </div>
    </div>

    <!-- Bootstrap 5.3 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Dream Stack Core -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>

    <!-- Utilidades -->
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.2/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/locale/es.js"></script>
    <script>dayjs.locale('es');</script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Charts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>

    <!-- Tailwind CSS (Desarrollo) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#714B67',
                        'primary-hover': '#5a3a52',
                        secondary: '#875A7B',
                        'bg-light': '#f5f7fa'
                    }
                }
            },
            corePlugins: {
                preflight: false, // Evita conflictos con Bootstrap
            }
        }
    </script>

    <!-- Common JS -->
    <script>
        /**
         * Loader global (toda la app)
         * - Maneja múltiples requests concurrentes con un contador
         * - Se activa automáticamente con Axios / HTMX / fetch / navegación
         */
        (function initGlobalLoader() {
            const spinner = document.querySelector('.loading-spinner');
            if (!spinner) return;

            let counter = 0;
            let showTimer = null;

            function render() {
                // Pequeño debounce para evitar "parpadeo" en requests muy rápidos
                if (counter > 0) {
                    if (!showTimer) {
                        showTimer = setTimeout(() => {
                            spinner.style.display = 'flex';
                            showTimer = null;
                        }, 120);
                    }
                } else {
                    if (showTimer) {
                        clearTimeout(showTimer);
                        showTimer = null;
                    }
                    spinner.style.display = 'none';
                }
            }

            window.AppLoading = {
                start() { counter += 1; render(); },
                stop() { counter = Math.max(0, counter - 1); render(); },
                reset() { counter = 0; render(); },
                getCount() { return counter; }
            };

            // Axios interceptors
            if (window.axios && typeof window.axios.interceptors === 'object') {
                window.axios.interceptors.request.use((config) => {
                    // Evitar loader en requests explícitamente marcados
                    if (!config?.headers?.['X-Skip-Global-Loader']) window.AppLoading.start();
                    return config;
                }, (error) => {
                    window.AppLoading.stop();
                    return Promise.reject(error);
                });

                window.axios.interceptors.response.use((response) => {
                    window.AppLoading.stop();
                    return response;
                }, (error) => {
                    window.AppLoading.stop();
                    return Promise.reject(error);
                });
            }

            // HTMX hooks
            document.body.addEventListener('htmx:beforeRequest', () => window.AppLoading.start());
            document.body.addEventListener('htmx:afterRequest', () => window.AppLoading.stop());
            document.body.addEventListener('htmx:responseError', () => window.AppLoading.stop());
            document.body.addEventListener('htmx:sendError', () => window.AppLoading.stop());

            // fetch() wrapper (para fetch sueltos en la app)
            const originalFetch = window.fetch;
            if (typeof originalFetch === 'function') {
                window.fetch = function(...args) {
                    window.AppLoading.start();
                    return originalFetch.apply(this, args)
                        .finally(() => window.AppLoading.stop());
                };
            }

            // Navegación: clicks en links y submits de formularios
            document.addEventListener('click', (e) => {
                const a = e.target?.closest?.('a');
                if (!a) return;
                if (a.target === '_blank') return;
                const href = a.getAttribute('href');
                if (!href || href.startsWith('#') || href.startsWith('javascript:')) return;
                // Si tiene atributos HTMX, lo gestiona HTMX (ya enganchado)
                if (a.hasAttribute('hx-get') || a.hasAttribute('hx-post')) return;
                // Solo same-origin
                try {
                    const url = new URL(href, window.location.href);
                    if (url.origin !== window.location.origin) return;
                } catch (_) { /* ignore */ }
                window.AppLoading.start();
            }, true);

            document.addEventListener('submit', (e) => {
                const form = e.target;
                if (!form || form.hasAttribute('hx-post') || form.hasAttribute('hx-get')) return;
                window.AppLoading.start();
            }, true);

            // Asegurar estado inicial correcto
            render();
        })();

        /**
         * Modo oscuro global (Bootstrap 5.3)
         * - Usa data-bs-theme="light|dark" en <html>
         * - Persiste preferencia en localStorage
         */
        (function initThemeToggle() {
            const root = document.documentElement; // <html>
            const btn = document.getElementById('theme-toggle');
            const icon = document.getElementById('theme-toggle-icon');

            function getPreferredTheme() {
                const saved = localStorage.getItem('theme');
                if (saved === 'light' || saved === 'dark') return saved;
                return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches
                    ? 'dark'
                    : 'light';
            }

            function applyTheme(theme) {
                root.setAttribute('data-bs-theme', theme);
                localStorage.setItem('theme', theme);
                if (icon) {
                    icon.className = theme === 'dark' ? 'bi bi-sun' : 'bi bi-moon-stars';
                }
                if (btn) {
                    btn.title = theme === 'dark' ? 'Cambiar a modo claro' : 'Cambiar a modo oscuro';
                }
            }

            applyTheme(getPreferredTheme());

            if (btn) {
                btn.addEventListener('click', () => {
                    const current = root.getAttribute('data-bs-theme') === 'dark' ? 'dark' : 'light';
                    applyTheme(current === 'dark' ? 'light' : 'dark');
                });
            }
        })();

        // Configuración global HTMX
        document.body.addEventListener('htmx:configRequest', (event) => {
            event.detail.headers['X-Requested-With'] = 'XMLHttpRequest';
        });
        
        // Cargar información del usuario dinámicamente desde la sesión
        function loadUserInfo() {
            // Obtener username desde el template si está disponible
            const userSpan = document.querySelector('.user-highlight');
            if (userSpan && userSpan.textContent.trim()) {
                // Ya está cargado desde el servidor
                return;
            }
            
            // Si no está disponible, intentar obtenerlo de la sesión Flask
            // Usamos un endpoint simple que devuelve la info de la sesión
            fetch('/api/v1/auth/user-info', {
                method: 'GET',
                credentials: 'same-origin'
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                }
                // Si no hay endpoint, intentar leer desde el DOM después de un pequeño delay
                setTimeout(() => {
                    const serverUsername = document.querySelector('.user-highlight');
                    if (serverUsername && serverUsername.textContent.trim()) {
                        // Ya se cargó desde el servidor
                        return;
                    }
                }, 100);
                throw new Error('No se pudo obtener información del usuario');
            })
            .then(data => {
                if (data && data.username) {
                    // Actualizar todos los elementos que muestran el username
                    document.querySelectorAll('.user-highlight').forEach(el => {
                        if (!el.textContent.trim()) {
                            el.textContent = data.username;
                        }
                    });
                    document.querySelectorAll('.user-details strong').forEach(el => {
                        if (!el.textContent.trim()) {
                            el.textContent = data.username;
                        }
                    });
                    if (data.email) {
                        document.querySelectorAll('.user-details small').forEach(el => {
                            if (!el.textContent.includes('@')) {
                                el.textContent = data.email;
                            }
                        });
                    }
                }
            })
            .catch(error => {
                // Si falla, intentar leer desde el DOM después de que se renderice
                setTimeout(() => {
                    const serverUsername = document.querySelector('.user-highlight');
                    if (serverUsername && serverUsername.textContent.trim()) {
                        // Ya se cargó desde el servidor, no hacer nada
                        return;
                    }
                }, 500);
            });
        }
        
        // Cargar información del usuario al cargar la página
        document.addEventListener('DOMContentLoaded', function() {
            // Esperar un momento para que el servidor renderice el template
            setTimeout(loadUserInfo, 100);
        });
        
        // Helpers globales
        window.formatCurrency = (value) => {
            return new Intl.NumberFormat('es-PE', { 
                style: 'currency', 
                currency: 'PEN' 
            }).format(value || 0);
        };
        
        window.showToast = (message, icon = 'success') => {
            Swal.fire({
                toast: true,
                position: 'top-end',
                icon: icon,
                title: message,
                showConfirmButton: false,
                timer: 3000
            });
        };
    </script>
    
    {% block extra_js %}{% endblock %}
</body>
</html>

