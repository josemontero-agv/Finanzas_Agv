{% extends "base.html" %}

{% block title %}Gesti√≥n de Cr√©ditos - Env√≠o de Correos{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header text-white d-flex justify-content-between align-items-center" style="background-color: #714B67;">
                    <h5 class="mb-0"><i class="fas fa-mail-bulk me-2"></i>Env√≠o de Correos Autom√°ticos - Cr√©ditos</h5>
                    <span class="badge" style="background-color: rgba(255, 255, 255, 0.2); color: white;"><i class="fas fa-user me-1"></i><span id="card-username">{{ session.username or '' }}</span></span>
                </div>
                <div class="card-body">
                    <ul class="nav nav-tabs mb-3" id="lettersTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="recover-tab" data-bs-toggle="tab" data-bs-target="#recover" type="button" role="tab" aria-controls="recover" aria-selected="true">
                                <i class="fas fa-file-signature me-2"></i>Letras por Recuperar
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="bank-tab" data-bs-toggle="tab" data-bs-target="#bank" type="button" role="tab" aria-controls="bank" aria-selected="false">
                                <i class="fas fa-university me-2"></i>Letras en Banco
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content" id="lettersTabContent">
                        <!-- Tab Letras por Recuperar -->
                        <div class="tab-pane fade show active" id="recover" role="tabpanel" aria-labelledby="recover-tab">
                            <div class="row mb-3">
                                <div class="col-md-3">
                                    <label class="form-label">Fecha Emisi√≥n Inicio</label>
                                    <input type="date" class="form-control" id="recover-date-start">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Fecha Emisi√≥n Fin</label>
                                    <input type="date" class="form-control" id="recover-date-end">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Cliente</label>
                                    <input type="text" class="form-control" id="recover-customer" placeholder="Buscar cliente...">
                                </div>
                                <div class="col-md-2 d-flex align-items-end">
                                    <button class="btn btn-secondary w-100" onclick="loadRecoverLetters()">
                                        <i class="fas fa-search me-1"></i>Buscar
                                    </button>
                                </div>
                            </div>

                            <div class="table-responsive mb-3">
                                <table class="text-sm" id="table-recover" style="width: 100%;">
                                    <thead class="text-white sticky top-0 z-10" style="background-color: #714B67;">
                                        <tr>
                                            <th class="px-3 py-3 text-left font-semibold whitespace-nowrap"><input type="checkbox" id="check-all-recover" class="form-check-input"></th>
                                            <th class="px-3 py-3 text-left font-semibold whitespace-nowrap">Ruc</th>
                                            <th class="px-3 py-3 text-left font-semibold whitespace-nowrap">Cliente</th>
                                            <th class="px-3 py-3 text-left font-semibold whitespace-nowrap">Letra</th>
                                            <th class="px-3 py-3 text-left font-semibold whitespace-nowrap">N√∫mero</th>
                                            <th class="px-3 py-3 text-right font-semibold whitespace-nowrap">Monto</th>
                                            <th class="px-3 py-3 text-left font-semibold whitespace-nowrap">Planilla Interna</th>
                                            <th class="px-3 py-3 text-left font-semibold whitespace-nowrap">F. Emision</th>
                                            <th class="px-3 py-3 text-left font-semibold whitespace-nowrap">F. Vencimiento</th>
                                            <th class="px-3 py-3 text-center font-semibold whitespace-nowrap">Estado</th>
                                            <th class="px-3 py-3 text-left font-semibold whitespace-nowrap">Vendedor</th>
                                            <th class="px-3 py-3 text-left font-semibold whitespace-nowrap">Ciudad</th>
                                            <th class="px-3 py-3 text-left font-semibold whitespace-nowrap">Referencia</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Data loaded via JS -->
                                    </tbody>
                                </table>
                            </div>

                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <span class="badge" style="background-color: #714B67; color: white;" id="selected-count">0 seleccionadas</span>
                                </div>
                                <div>
                                    <button class="btn btn-success" onclick="sendRecoverEmails()" id="btn-send-emails">
                                        <i class="fas fa-paper-plane me-2"></i>Enviar Recordatorios de Firma
                                    </button>
                                </div>
                            </div>
                            
                            <div class="alert alert-info mt-3">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>L√≥gica de Estado:</strong>
                                <ul class="mb-0 mt-1 small">
                                    <li><strong>Lima:</strong> Se marca "POR RECUPERAR" si han pasado > 4 d√≠as desde la fecha de emisi√≥n.</li>
                                    <li><strong>Provincia:</strong> Se marca "POR RECUPERAR" si han pasado > 10 d√≠as desde la fecha de emisi√≥n.</li>
                                    <li>En caso contrario, el estado es "VIGENTE".</li>
                                </ul>
                            </div>
                        </div>

                        <!-- Tab Letras en Banco -->
                        <div class="tab-pane fade" id="bank" role="tabpanel" aria-labelledby="bank-tab">
                            <!-- Manteniendo dise√±o anterior para banco por ahora, ajustando colores -->
                            <div class="row mb-3">
                                <div class="col-md-3">
                                    <label class="form-label">Fecha Inicio</label>
                                    <input type="date" class="form-control" id="bank-date-start">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Fecha Fin</label>
                                    <input type="date" class="form-control" id="bank-date-end">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Banco</label>
                                    <select class="form-select" id="bank-select">
                                        <option value="">Todos</option>
                                        <option value="BBVA">BBVA</option>
                                        <option value="BCP">BCP</option>
                                        <option value="INTERBANK">Interbank</option>
                                    </select>
                                </div>
                                <div class="col-md-2 d-flex align-items-end">
                                    <button class="btn btn-secondary w-100" onclick="loadBankLetters()">
                                        <i class="fas fa-search me-1"></i>Buscar
                                    </button>
                                </div>
                            </div>

                            <div class="table-responsive mb-3">
                                <table class="table table-hover align-middle" id="table-bank">
                                    <thead style="background-color: #714B67; color: white;">
                                        <tr>
                                            <th scope="col"><input type="checkbox" id="check-all-bank" class="form-check-input"></th>
                                            <th scope="col">Letra N¬∞</th>
                                            <th scope="col">N√∫mero Pago</th>
                                            <th scope="col">Cliente</th>
                                            <th scope="col">Banco</th>
                                            <th scope="col">Fecha Vcto.</th>
                                            <th scope="col">Importe</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Data loaded via JS -->
                                    </tbody>
                                </table>
                            </div>

                            <div class="d-flex justify-content-end">
                                <button class="btn btn-success" onclick="sendBankEmails()">
                                    <i class="fas fa-paper-plane me-2"></i>Enviar Aviso de Pago
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Set default dates (first and last day of current month)
        const date = new Date();
        const firstDay = new Date(date.getFullYear(), date.getMonth(), 1).toISOString().split('T')[0];
        const lastDay = new Date(date.getFullYear(), date.getMonth() + 1, 0).toISOString().split('T')[0];
        
        document.getElementById('recover-date-start').value = firstDay;
        document.getElementById('recover-date-end').value = lastDay;
        document.getElementById('bank-date-start').value = firstDay;
        document.getElementById('bank-date-end').value = lastDay;

        // Cargar username en el card si no est√° disponible
        if (!document.getElementById('card-username').textContent.trim()) {
            fetch('/api/v1/auth/user-info')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.username) {
                        document.getElementById('card-username').textContent = data.username;
                    }
                })
                .catch(err => console.warn('No se pudo cargar username:', err));
        }
        
        // Load initial data
        loadRecoverLetters();
        
        // Event listeners for tabs to load data when switched
        document.getElementById('bank-tab').addEventListener('shown.bs.tab', function (e) {
            loadBankLetters();
        });

        // Check all functionality
        document.getElementById('check-all-recover').addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('#table-recover tbody input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = this.checked);
            updateSelectedCount();
        });
        
        // Actualizar contador de seleccionadas
        function updateSelectedCount() {
            const selected = document.querySelectorAll('#table-recover tbody input[type="checkbox"]:checked').length;
            document.getElementById('selected-count').textContent = `${selected} seleccionada${selected !== 1 ? 's' : ''}`;
        }
        
        // Actualizar contador cuando se selecciona/deselecciona una letra
        document.addEventListener('change', function(e) {
            if (e.target.classList.contains('letter-check')) {
                updateSelectedCount();
            }
        });

        document.getElementById('check-all-bank').addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('#table-bank tbody input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = this.checked);
        });
    });

    function loadRecoverLetters() {
        console.log('[loadRecoverLetters] Funci√≥n llamada');
        
        const tbody = document.querySelector('#table-recover tbody');
        if (!tbody) {
            console.error('[ERROR] No se encontr√≥ #table-recover tbody');
            return;
        }
        
        console.log('[loadRecoverLetters] Tbody encontrado, mostrando spinner');
        tbody.innerHTML = '<tr class="hover:bg-gray-50"><td colspan="13" class="px-3 py-2 text-sm text-center"><div class="spinner-border" style="color: #714B67;" role="status"></div> Cargando...</td></tr>';

        console.log('[loadRecoverLetters] Haciendo fetch a /api/v1/letters/to-accept');
        // Agregar timestamp para evitar cach√©
        const timestamp = new Date().getTime();
        fetch(`/api/v1/letters/to-accept?_t=${timestamp}`, {
            cache: 'no-cache',
            headers: {
                'Cache-Control': 'no-cache'
            }
        })
            .then(response => {
                console.log('[loadRecoverLetters] Response recibida, status:', response.status);
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.message || `HTTP error! status: ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('[loadRecoverLetters] ===== DATOS RECIBIDOS =====');
                console.log('Respuesta completa:', JSON.stringify(data, null, 2));
                console.log('Success:', data.success);
                console.log('Data:', data.data);
                console.log('Data es array?', Array.isArray(data.data));
                console.log('Data length:', data.data ? data.data.length : 0);
                
                // Limpiar tabla
                tbody.innerHTML = '';
                
                // Validar estructura de respuesta
                if (!data) {
                    console.error('[ERROR] No se recibi√≥ respuesta del servidor');
                    tbody.innerHTML = '<tr><td colspan="13" class="text-center text-danger">Error: No se recibi√≥ respuesta del servidor</td></tr>';
                    return;
                }
                
                if (data.success && data.data && Array.isArray(data.data) && data.data.length > 0) {
                    console.log(`[loadRecoverLetters] Procesando ${data.data.length} letras`);
                    
                    let rowsHtml = '';
                    data.data.forEach((item, index) => {
                        console.log(`[loadRecoverLetters] Letra ${index + 1}:`, JSON.stringify(item, null, 2));
                        
                        // Validar y formatear campos
                        const status = (item.status_calc || 'VIGENTE').toString().trim();
                        const statusClass = status === 'POR RECUPERAR' 
                            ? 'bg-yellow-100 text-yellow-800' 
                            : 'bg-green-100 text-green-800';
                        
                        const amount = parseFloat(item.amount || 0) || 0;
                        const amountFormatted = amount.toLocaleString('es-PE', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                        
                        // Formatear fechas si vienen en formato YYYY-MM-DD
                        const formatDate = (dateStr) => {
                            if (!dateStr) return '';
                            try {
                                const date = new Date(dateStr);
                                if (isNaN(date.getTime())) return dateStr;
                                return date.toLocaleDateString('es-PE', { day: '2-digit', month: '2-digit', year: 'numeric' });
                            } catch (e) {
                                return dateStr;
                            }
                        };
                        
                        // Escapar HTML para prevenir XSS
                        const escapeHtml = (text) => {
                            if (!text) return '';
                            const div = document.createElement('div');
                            div.textContent = text;
                            return div.innerHTML;
                        };
                        
                        rowsHtml += `
                            <tr class="hover:bg-gray-50 transition-colors">
                                <td class="px-3 py-2 text-sm text-left whitespace-nowrap"><input type="checkbox" class="letter-check form-check-input" value="${escapeHtml(String(item.id || ''))}" data-customer="${escapeHtml(String(item.acceptor_id || ''))}" data-email="${escapeHtml(String(item.customer_email || ''))}"></td>
                                <td class="px-3 py-2 text-sm text-left whitespace-nowrap">${escapeHtml(String(item.vat || ''))}</td>
                                <td class="px-3 py-2 text-sm text-left whitespace-nowrap">${escapeHtml(String(item.acceptor_id || item.customer_name || ''))}</td>
                                <td class="px-3 py-2 text-sm text-left whitespace-nowrap">${escapeHtml(String(item.number || item.l10n_latam_boe_number || ''))}</td>
                                <td class="px-3 py-2 text-sm text-left whitespace-nowrap">${escapeHtml(String(item.ref_docs || ''))}</td>
                                <td class="px-3 py-2 text-sm text-right whitespace-nowrap">${amountFormatted}</td>
                                <td class="px-3 py-2 text-sm text-left whitespace-nowrap">${escapeHtml(String(item.invoice_origin || ''))}</td>
                                <td class="px-3 py-2 text-sm text-left whitespace-nowrap">${formatDate(item.date || item.invoice_date || '')}</td>
                                <td class="px-3 py-2 text-sm text-left whitespace-nowrap">${formatDate(item.due_date || item.invoice_date_due || '')}</td>
                                <td class="px-3 py-2 text-sm text-center whitespace-nowrap"><span class="px-2 py-1 rounded text-xs ${statusClass}">${escapeHtml(status)}</span></td>
                                <td class="px-3 py-2 text-sm text-left whitespace-nowrap">${escapeHtml(String(item.salesperson || ''))}</td>
                                <td class="px-3 py-2 text-sm text-left whitespace-nowrap">${escapeHtml(String(item.city || ''))}</td>
                                <td class="px-3 py-2 text-sm text-left whitespace-nowrap">${escapeHtml(String(item.ref || ''))}</td>
                            </tr>
                        `;
                    });
                    
                    console.log('[loadRecoverLetters] HTML generado, insertando en tabla');
                    console.log('[loadRecoverLetters] Longitud del HTML:', rowsHtml.length);
                    tbody.innerHTML = rowsHtml;
                    console.log(`[loadRecoverLetters] ‚úÖ ${data.data.length} letras insertadas en la tabla`);
                    
                    // Verificar que se insertaron las filas
                    const insertedRows = tbody.querySelectorAll('tr');
                    console.log(`[loadRecoverLetters] Filas insertadas en DOM: ${insertedRows.length}`);
                    
                    updateSelectedCount();
                } else {
                    const msg = data.message || 'No se encontraron letras pendientes de firma (estado: Por aceptar)';
                    console.warn('[loadRecoverLetters] No hay datos:', msg);
                    console.warn('[loadRecoverLetters] Estructura de respuesta:', {
                        success: data.success,
                        hasData: !!data.data,
                        isArray: Array.isArray(data.data),
                        length: data.data ? data.data.length : 0
                    });
                    tbody.innerHTML = `<tr class="hover:bg-gray-50"><td colspan="13" class="px-3 py-2 text-sm text-center text-muted">${escapeHtml(msg)}</td></tr>`;
                    document.getElementById('selected-count').textContent = '0 seleccionadas';
                }
            })
            .catch(error => {
                console.error('[loadRecoverLetters] ERROR:', error);
                const errorMsg = escapeHtml(error.message || 'Error desconocido');
                tbody.innerHTML = `<tr class="hover:bg-gray-50"><td colspan="13" class="px-3 py-2 text-sm text-center text-danger">Error: ${errorMsg}<br><small>Revisa la consola (F12)</small></td></tr>`;
                document.getElementById('selected-count').textContent = '0 seleccionadas';
            });
    }

    function loadBankLetters() {
        const start = document.getElementById('bank-date-start').value;
        const end = document.getElementById('bank-date-end').value;
        const bank = document.getElementById('bank-select').value;

        const tbody = document.querySelector('#table-bank tbody');
        tbody.innerHTML = '<tr><td colspan="7" class="text-center"><div class="spinner-border" style="color: #714B67;" role="status"></div></td></tr>';

        fetch(`/api/v1/letters/in-bank?start_date=${start}&end_date=${end}&bank=${bank}`)
            .then(response => response.json())
            .then(data => {
                tbody.innerHTML = '';
                if (data.success && data.data.length > 0) {
                    data.data.forEach(item => {
                        const row = `
                            <tr>
                                <td><input type="checkbox" class="letter-check form-check-input" value="${item.id}"></td>
                                <td>${item.number}</td>
                                <td><strong>${item.payment_number}</strong></td>
                                <td>${item.customer}</td>
                                <td>${item.bank}</td>
                                <td>${item.due_date}</td>
                                <td>${item.amount} ${item.currency}</td>
                            </tr>
                        `;
                        tbody.innerHTML += row;
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center">No se encontraron letras en banco</td></tr>';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">Error al cargar datos</td></tr>';
            });
    }

    function sendRecoverEmails() {
        const selected = Array.from(document.querySelectorAll('#table-recover tbody input[type="checkbox"]:checked')).map(cb => cb.value);
        
        if (selected.length === 0) {
            alert('‚ö†Ô∏è Por favor seleccione al menos una letra');
            return;
        }

        // Obtener informaci√≥n de los correos que se enviar√°n
        const selectedRows = Array.from(document.querySelectorAll('#table-recover tbody input[type="checkbox"]:checked'));
        const emails = new Set();
        selectedRows.forEach(cb => {
            const email = cb.getAttribute('data-email');
            if (email) emails.add(email);
        });

        let confirmMsg = `¬øEst√° seguro de enviar correos para ${selected.length} letra(s) seleccionada(s)?\n\n`;
        confirmMsg += `Se enviar√° a ${emails.size} cliente(s):\n`;
        emails.forEach(email => confirmMsg += `- ${email}\n`);

        if (!confirm(confirmMsg)) {
            return;
        }

        // Deshabilitar bot√≥n durante el env√≠o
        const btn = document.getElementById('btn-send-emails');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Enviando...';

        // Enviar usando el endpoint de aceptaci√≥n
        fetch('/api/v1/letters/send-acceptance', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ letter_ids: selected })
        })
        .then(response => response.json())
        .then(data => {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-paper-plane me-2"></i>Enviar Recordatorios de Firma';
            
            if (data.success) {
                const details = data.details || {};
                let message = `‚úÖ Correos enviados exitosamente\n\n`;
                message += `üìß Enviados: ${details.sent || 0}\n`;
                message += `‚ùå Fallidos: ${details.failed || 0}\n`;
                if (details.errors && details.errors.length > 0) {
                    message += `\nErrores:\n${details.errors.slice(0, 3).join('\n')}`;
                }
                alert(message);
                loadRecoverLetters(); // Recargar tabla
            } else {
                alert('‚ùå Error al enviar correos: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-paper-plane me-2"></i>Enviar Recordatorios de Firma';
            alert('‚ùå Error de conexi√≥n: ' + error.message);
        });
    }

    function sendBankEmails() {
        const selected = Array.from(document.querySelectorAll('#table-bank tbody input[type="checkbox"]:checked')).map(cb => cb.value);
        
        if (selected.length === 0) {
            alert('Por favor seleccione al menos una letra');
            return;
        }

        if (!confirm(`¬øEst√° seguro de enviar avisos de pago para ${selected.length} letras seleccionadas?`)) {
            return;
        }

        fetch('/api/v1/letters/send-bank', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ letter_ids: selected })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Avisos enviados exitosamente');
                loadBankLetters();
            } else {
                alert('Error al enviar correos: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error de conexi√≥n');
        });
    }
</script>
{% endblock %}
