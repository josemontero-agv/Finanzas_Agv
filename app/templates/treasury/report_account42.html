{% extends "base.html" %}

{% block title %}Reporte Cuenta 42 - Tesorería{% endblock %}

{% block content %}
<div x-data="reportController()" x-init="init()" class="w-full" style="max-width: 100%; overflow-x: hidden;">
    <!-- Header -->
    <div class="flex justify-between items-center pb-4 mb-4 border-b border-gray-200" style="max-width: 100%;">
        <h1 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
            <i class="bi bi-file-earmark-text text-primary"></i>
            Reporte Cuenta 42 - Cuentas por Pagar
        </h1>
        <div class="flex gap-2">
            <button @click="exportToExcel()" 
                    class="inline-flex items-center justify-center w-10 h-10 rounded-lg bg-green-600 hover:bg-green-700 text-white transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                    :disabled="loading"
                    title="Exportar a Excel">
                <i class="bi bi-file-earmark-excel text-lg"></i>
            </button>
            <button @click="refreshData()" 
                    class="inline-flex items-center justify-center w-10 h-10 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                    :class="loading ? 'bg-gray-400' : 'bg-primary hover:bg-primary-hover'"
                    style="background-color: var(--primary-color);"
                    :disabled="loading"
                    title="Actualizar datos">
                <i class="bi text-lg text-white" :class="loading ? 'bi-hourglass-split animate-spin' : 'bi-arrow-clockwise'"></i>
            </button>
        </div>
    </div>

    <!-- Filtros con Alpine.js -->
    <div class="bg-white rounded-lg shadow-sm p-4 mb-4">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Fecha de Corte (Histórico)</label>
                <input type="date" 
                       x-model="filters.date_cutoff"
                       class="form-control border-primary"
                       title="Si selecciona fecha de corte, muestra el estado al cierre de ese día">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1" :class="{'text-gray-400': filters.date_cutoff}">Fecha Desde (Emisión)</label>
                <input type="date" 
                       x-model="filters.date_from"
                       class="form-control"
                       :disabled="!!filters.date_cutoff">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1" :class="{'text-gray-400': filters.date_cutoff}">Fecha Hasta (Emisión)</label>
                <input type="date" 
                       x-model="filters.date_to"
                       class="form-control"
                       :disabled="!!filters.date_cutoff">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Proveedor</label>
                <input type="text" 
                       x-model="filters.supplier"
                       placeholder="Buscar proveedor..."
                       class="form-control">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Referencia / N° Factura</label>
                <input type="text" 
                       x-model="filters.reference"
                       placeholder="Ej: FAC-001234 o 1234"
                       class="form-control"
                       title="Filtra por el número de factura (campo ref)">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Cuenta Contable (Códigos)</label>
                <input type="text" 
                       x-model="filters.account_codes_text"
                       placeholder="Ej: 421,422,423 o 421"
                       class="form-control"
                       title="Ingrese códigos de cuenta separados por comas sin espacios">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Tipo Documento</label>
                <select x-model="filters.doc_type_id" class="form-select">
                    <option value="">Todos</option>
                    <template x-for="type in documentTypes" :key="type.id">
                        <option :value="type.id" x-text="type.name"></option>
                    </template>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Límite</label>
                <select x-model="filters.limit" class="form-select">
                    <option value="500">500 registros</option>
                    <option value="1000">1000 registros</option>
                    <option value="5000">5000 registros</option>
                    <option value="10000">Todos</option>
                </select>
            </div>
            <div class="flex items-end pb-2 gap-4">
                <label class="inline-flex items-center cursor-pointer">
                    <input type="checkbox"
                           x-model="filters.use_supabase"
                           class="form-checkbox h-5 w-5 text-primary border-gray-300 rounded focus:ring-primary">
                    <span class="ml-2 text-sm font-bold text-blue-700">Usar Supabase (Neteado)</span>
                </label>
                <label class="inline-flex items-center cursor-pointer">
                    <input type="checkbox"
                           x-model="filters.only_vouchers"
                           class="form-checkbox h-5 w-5 text-primary border-gray-300 rounded focus:ring-primary"
                           :disabled="filters.use_supabase">
                    <span class="ml-2 text-sm text-gray-700" :class="{'text-gray-400': filters.use_supabase}">Solo Comprobantes</span>
                </label>
                <label class="inline-flex items-center cursor-pointer">
                    <input type="checkbox"
                           x-model="filters.include_reconciled"
                           class="form-checkbox h-5 w-5 text-primary border-gray-300 rounded focus:ring-primary"
                           :disabled="filters.use_supabase">
                    <span class="ml-2 text-sm text-gray-700" :class="{'text-gray-400': filters.use_supabase}">Incluir Pagados</span>
                </label>
            </div>
        </div>
        <div class="mt-4 flex gap-2">
            <button @click="applyFilters()" 
                    class="inline-flex items-center justify-center px-4 py-2 rounded-lg text-white font-medium transition-colors"
                    style="background-color: var(--primary-color);"
                    :disabled="loading"
                    title="Buscar">
                <i class="bi bi-search mr-2"></i> Buscar
            </button>
            <button @click="resetFilters()" 
                    class="inline-flex items-center justify-center px-4 py-2 rounded-lg bg-gray-500 hover:bg-gray-600 text-white font-medium transition-colors"
                    :disabled="loading"
                    title="Limpiar filtros">
                <i class="bi bi-x-circle mr-2"></i> Limpiar
            </button>
        </div>
    </div>

    <!-- KPI Summary Ribbon Removed -->

    <!-- Resumen al corte -->
    <div class="bg-white rounded-lg shadow-sm p-4 mb-4" x-show="summary && summary.overall">
        <div class="flex justify-between items-center mb-3">
            <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                <i class="bi bi-calculator text-primary"></i>
                Resumen General
            </h3>
            <div class="bg-gray-100 px-4 py-2 rounded-lg">
                <span class="text-sm text-gray-600">Total de registros: </span>
                <span class="text-lg font-bold text-gray-900" x-text="allData.length"></span>
            </div>
        </div>
        <div class="flex flex-wrap gap-4">
            <div class="flex-1 min-w-[220px] border-2 border-blue-200 rounded-lg p-3 bg-blue-50">
                <p class="text-sm text-blue-700 font-medium">Débito</p>
                <p class="text-2xl font-bold text-blue-900" x-text="formatNumberWithCommas(summary.overall.debit || 0)"></p>
            </div>
            <div class="flex-1 min-w-[220px] border-2 border-green-200 rounded-lg p-3 bg-green-50">
                <p class="text-sm text-green-700 font-medium">Haber</p>
                <p class="text-2xl font-bold text-green-900" x-text="formatNumberWithCommas(summary.overall.credit || 0)"></p>
            </div>
            <div class="flex-1 min-w-[220px] border-2 border-purple-200 rounded-lg p-3 bg-purple-50">
                <p class="text-sm text-purple-700 font-medium">Saldo (Debe - Haber)</p>
                <p class="text-2xl font-bold text-purple-900" x-text="formatNumberWithCommas(summary.overall.saldo || 0)"></p>
            </div>
            <div class="flex-1 min-w-[220px] border-2 border-orange-200 rounded-lg p-3 bg-orange-50" x-show="filters.date_cutoff">
                <p class="text-sm text-orange-700 font-medium">Pendiente al corte</p>
                <p class="text-2xl font-bold text-orange-900" x-text="formatNumberWithCommas(summary.overall.pending_cutoff || 0)"></p>
            </div>
            <div class="flex-1 min-w-[220px] border-2 border-red-200 rounded-lg p-3 bg-red-50" x-show="filters.date_cutoff">
                <p class="text-sm text-red-700 font-medium">Pagado después del corte</p>
                <p class="text-2xl font-bold text-red-900" x-text="formatNumberWithCommas(summary.overall.paid_after_cutoff || 0)"></p>
            </div>
        </div>
        
        <div class="mt-4">
            <p class="text-sm font-semibold text-gray-700 mb-2">Resumen por cuenta</p>
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm">
                    <thead class="bg-gray-100 text-gray-700">
                        <tr>
                            <th class="px-3 py-2 text-left font-semibold">Cuenta</th>
                            <th class="px-3 py-2 text-left font-semibold">Nombre</th>
                            <th class="px-3 py-2 text-center font-semibold">Registros</th>
                            <th class="px-3 py-2 text-right font-semibold">Débito</th>
                            <th class="px-3 py-2 text-right font-semibold">Haber</th>
                            <th class="px-3 py-2 text-right font-semibold">Saldo (Debe - Haber)</th>
                            <th class="px-3 py-2 text-right font-semibold" x-show="filters.date_cutoff">Pendiente al corte</th>
                            <th class="px-3 py-2 text-right font-semibold" x-show="filters.date_cutoff">Pagado después corte</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="row in summary.by_account" :key="row.account_code">
                            <tr class="border-b border-gray-100 hover:bg-gray-50">
                                <td class="px-3 py-2 whitespace-nowrap font-mono" x-text="row.account_code"></td>
                                <td class="px-3 py-2 truncate" x-text="row.account_name"></td>
                                <td class="px-3 py-2 text-center font-semibold" x-text="row.count || 0"></td>
                                <td class="px-3 py-2 text-right font-mono" x-text="formatNumberWithCommas(row.debit || 0)"></td>
                                <td class="px-3 py-2 text-right font-mono" x-text="formatNumberWithCommas(row.credit || 0)"></td>
                                <td class="px-3 py-2 text-right font-mono font-bold" x-text="formatNumberWithCommas((row.saldo !== undefined ? row.saldo : (row.debit - row.credit)) || 0)"></td>
                                <td class="px-3 py-2 text-right font-mono" x-show="filters.date_cutoff" x-text="formatNumberWithCommas(row.pending_cutoff || 0)"></td>
                                <td class="px-3 py-2 text-right font-mono" x-show="filters.date_cutoff" x-text="formatNumberWithCommas(row.paid_after_cutoff || 0)"></td>
                            </tr>
                        </template>
                        <tr x-show="!summary.by_account || summary.by_account.length === 0">
                            <td colspan="8" class="px-3 py-2 text-center text-gray-500">Sin datos de resumen</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Tabla con Sticky Headers -->
    <div class="bg-white rounded-lg shadow-sm overflow-hidden" style="max-width: 100%; width: 100%;">
        <div class="overflow-x-auto overflow-y-auto" style="max-height: 75vh; scroll-behavior: smooth; width: 100%;">
            <table class="text-sm" style="width: max-content; min-width: 100%;">
                <thead class="text-white sticky top-0 z-10" style="background-color: var(--primary-color);">
                    <tr>
                        <th class="px-3 py-3 text-left font-semibold whitespace-nowrap">Fecha Factura</th>
                        <th class="px-3 py-3 text-left font-semibold whitespace-nowrap">Fecha Contabilización</th>
                        <th class="px-3 py-3 text-left font-semibold whitespace-nowrap">Tipo Documento</th>
                        <th class="px-3 py-3 text-left font-semibold whitespace-nowrap">Número Documento</th>
                        <th class="px-3 py-3 text-left font-semibold whitespace-nowrap">Número Letra</th>
                        <th class="px-3 py-3 text-left font-semibold whitespace-nowrap">Referencia</th>
                        <th class="px-3 py-3 text-left font-semibold whitespace-nowrap">Origen</th>
                        <th class="px-3 py-3 text-left font-semibold whitespace-nowrap">Cuenta</th>
                        <th class="px-3 py-3 text-left font-semibold whitespace-nowrap">Nombre Cuenta</th>
                        <th class="px-3 py-3 text-left font-semibold whitespace-nowrap">RUC Proveedor</th>
                        <th class="px-3 py-3 text-left font-semibold whitespace-nowrap">Proveedor</th>
                        <th class="px-3 py-3 text-left font-semibold whitespace-nowrap">Descripción</th>
                        <th class="px-3 py-3 text-left font-semibold whitespace-nowrap">Email</th>
                        
                        <th class="px-3 py-3 text-left font-semibold whitespace-nowrap">Moneda Doc</th>
                        <th class="px-3 py-3 text-right font-semibold whitespace-nowrap">Total Origen</th>
                        <th class="px-3 py-3 text-right font-semibold whitespace-nowrap">Adeudado Origen</th>
                        <th class="px-3 py-3 text-right font-semibold whitespace-nowrap">Total S/.</th>
                        <th class="px-3 py-3 text-right font-semibold whitespace-nowrap">Débito</th>
                        <th class="px-3 py-3 text-right font-semibold whitespace-nowrap">Haber</th>
                        <th class="px-3 py-3 text-right font-semibold whitespace-nowrap">Pendiente al Corte</th>
                        <th class="px-3 py-3 text-right font-semibold whitespace-nowrap">Pagado Después Corte</th>
                        <th class="px-3 py-3 text-left font-semibold whitespace-nowrap">Fecha Vencimiento</th>
                        <th class="px-3 py-3 text-center font-semibold whitespace-nowrap">Días Vencido</th>
                        <th class="px-3 py-3 text-center font-semibold whitespace-nowrap">Estado</th>
                        <th class="px-3 py-3 text-left font-semibold whitespace-nowrap">Antigüedad</th>
                        <!-- Eliminado Condición Pago -->
                        <th class="px-3 py-3 text-left font-semibold whitespace-nowrap">Estado Pago</th>
                        <!-- Eliminado Usuario Responsable -->
                    </tr>
                </thead>
                <tbody id="table-body">
                    <!-- Filas se cargarán aquí vía JavaScript -->
                </tbody>
            </table>
            <!-- Sentinel for infinite scroll -->
            <div id="scroll-sentinel" class="h-4 w-full"></div>
        </div>
        
    </div>
</div>

<!-- Alpine.js Controller -->
<script>
function reportController() {
    return {
        loading: false,
        filters: {
            date_from: '',
            date_to: '',
            date_cutoff: '', // Nuevo filtro
            supplier: '',
            reference: '',
            account_codes_text: '421,422,423,424',
            limit: '1000',
            doc_type_id: '',
            only_vouchers: true, // Por defecto activado
            include_reconciled: false,
            use_supabase: true // NUEVO: Por defecto usar Supabase (Neteado)
        },
        allData: [], // Almacena TODOS los datos
        pageSize: 50, // Renderizar de 50 en 50
        currentIndex: 0,
        documentTypes: [],
        summary: { overall: {}, by_account: [] },
        observer: null,
        
        async init() {
            await this.loadFilterOptions();
            this.setupObserver();
            await this.loadData();
        },
        
        async loadFilterOptions() {
            try {
                const { data } = await axios.get('/api/v1/treasury/filter-options');
                if (data.success) {
                    this.documentTypes = data.data.document_types;
                }
            } catch (error) {
                console.error('Error loading filter options:', error);
            }
        },
        
        // Procesar el texto de códigos de cuenta
        getAccountCodesForAPI() {
            const text = this.filters.account_codes_text.trim();
            if (!text) return '';
            return text.split(',').map(code => code.trim()).filter(code => code).join(',');
        },
        
        setupObserver() {
            const options = {
                root: document.querySelector('.overflow-y-auto'),
                rootMargin: '100px',
                threshold: 0.1
            };
            
            this.observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting && !this.loading && this.currentIndex < this.allData.length) {
                        this.renderNextChunk();
                    }
                });
            }, options);
            
            const sentinel = document.getElementById('scroll-sentinel');
            if (sentinel) this.observer.observe(sentinel);
        },
        
        async loadData() {
            this.loading = true;
            this.currentIndex = 0;
            this.summary = { overall: {}, by_account: [] };
            document.getElementById('table-body').innerHTML = ''; // Limpiar tabla
            
            try {
                // Construir params
                const params = new URLSearchParams();
                Object.keys(this.filters).forEach(key => {
                    let value = this.filters[key];
                    if (key === 'account_codes_text') {
                        value = this.getAccountCodesForAPI();
                        key = 'account_codes';
                    }
                    if (value && value !== '') {
                        params.set(key, value);
                    }
                });
                
                console.log('[DEBUG] Parámetros de consulta:', Object.fromEntries(params));
                
                const endpoint = this.filters.use_supabase 
                    ? `/api/v1/treasury/report/account42-netted?${params}` 
                    : `/api/v1/treasury/report/account42?${params}`;
                
                const response = await axios.get(endpoint);
                
                console.log('[DEBUG] Respuesta del servidor:', response.data);
                
                if (response.data && response.data.success) {
                    this.allData = response.data.data || [];
                    this.summary = response.data.summary || { overall: {}, by_account: [] };
                    
                    console.log('[DEBUG] Total de registros:', this.allData.length);
                    console.log('[DEBUG] Resumen:', this.summary);
                    
                    if (this.allData.length === 0) {
                        this.showEmptyState();
                    } else {
                        this.renderNextChunk(); // Renderizar primer chunk
                    }
                    
                    showToast(`Cargados ${this.allData.length} registros`, 'success');
                } else {
                    showToast('Error al cargar datos', 'error');
                }
            } catch (error) {
                console.error('Error loading data:', error);
                showToast('Error al conectar con la API: ' + (error.message || 'Error desconocido'), 'error');
            } finally {
                this.loading = false;
            }
        },
        
        renderNextChunk() {
            const nextIndex = Math.min(this.currentIndex + this.pageSize, this.allData.length);
            const chunk = this.allData.slice(this.currentIndex, nextIndex);
            
            if (chunk.length > 0) {
                this.appendRows(chunk);
                this.currentIndex = nextIndex;
            }
        },
        
        showEmptyState() {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = `
                <tr>
                    <td colspan="28" class="text-center py-8 text-gray-500">
                        <i class="bi bi-inbox text-4xl mb-2"></i>
                        <p>No se encontraron registros</p>
                    </td>
                </tr>
            `;
        },
        
        appendRows(data) {
            const tbody = document.getElementById('table-body');
            const html = data.map(row => {
                // Normalización para datos de Supabase vs Odoo
                const isNetted = this.filters.use_supabase;
                
                const invoice_date = isNetted ? row.date_emitted : (row.invoice_date || '');
                const move_name = isNetted ? row.invoice_name : (row.move_name || '');
                const ref = isNetted ? row.invoice_ref : (row.ref || '');
                const supplier_name = row.supplier_name || '';
                const supplier_vat = row.supplier_vat || '';
                const amount_total = isNetted ? row.original_amount : (row.amount_total_signed || 0);
                const actual_balance = isNetted ? row.actual_balance : (row.amount_residual_historical ?? row.amount_residual ?? 0);
                const payment_state = isNetted ? row.odoo_payment_state : (row.payment_state || '');
                const date_due = isNetted ? row.date_due : (row.invoice_date_due || '');
                
                const diasClass = (row.dias_vencido || 0) > 0 ? 'text-red-600 font-bold' : '';
                const estadoBadge = row.estado_deuda === 'VENCIDO' 
                    ? 'bg-red-100 text-red-800' 
                    : 'bg-green-100 text-green-800';
                
                return `
                    <tr class="hover:bg-gray-50 transition-colors ${isNetted ? 'bg-blue-50/30' : ''}">
                        <td class="px-3 py-2 text-sm text-left whitespace-nowrap">${invoice_date}</td>
                        <td class="px-3 py-2 text-sm text-left whitespace-nowrap">${isNetted ? '-' : (row.date || '')}</td>
                        <td class="px-3 py-2 text-sm text-left whitespace-nowrap">${isNetted ? 'Factura' : (row.l10n_latam_document_type_id || '(00)')}</td>
                        <td class="px-3 py-2 text-sm text-left truncate-cell" title="${move_name}">${move_name}</td>
                        <td class="px-3 py-2 text-sm text-left whitespace-nowrap">${row.l10n_latam_boe_number || ''}</td>
                        <td class="px-3 py-2 text-sm text-left truncate-cell" title="${ref}">${ref}</td>
                        <td class="px-3 py-2 text-sm text-left whitespace-nowrap">${row.invoice_origin || ''}</td>
                        <td class="px-3 py-2 text-sm text-left whitespace-nowrap">${row.account_code || ''}</td>
                        <td class="px-3 py-2 text-sm text-left truncate-cell" title="${row.account_name || ''}">${row.account_name || ''}</td>
                        <td class="px-3 py-2 text-sm text-left whitespace-nowrap">${supplier_vat}</td>
                        <td class="px-3 py-2 text-sm text-left truncate-cell" title="${supplier_name}">${supplier_name}</td>
                        <td class="px-3 py-2 text-sm text-left truncate-cell" title="${row.narration || ''}">${row.narration || ''}</td>
                        <td class="px-3 py-2 text-sm text-left truncate-cell" title="${row.supplier_email || ''}">${row.supplier_email || ''}</td>
                        
                        <td class="px-3 py-2 text-sm text-left whitespace-nowrap">${row.currency_id || ''}</td>
                        <td class="px-3 py-2 text-sm text-right whitespace-nowrap">${isNetted ? '-' : this.formatNumberWithCommas(row.amount_total_in_currency_signed)}</td>
                        <td class="px-3 py-2 text-sm text-right whitespace-nowrap">${isNetted ? '-' : this.formatNumberWithCommas(row.amount_residual_with_retention)}</td>
                        <td class="px-3 py-2 text-sm text-right whitespace-nowrap">${this.formatNumberWithCommas(amount_total)}</td>
                        <td class="px-3 py-2 text-sm text-right whitespace-nowrap">${isNetted ? '-' : this.formatNumberWithCommas(row.debit)}</td>
                        <td class="px-3 py-2 text-sm text-right whitespace-nowrap">${isNetted ? '-' : this.formatNumberWithCommas(row.credit)}</td>
                        <td class="px-3 py-2 text-sm text-right whitespace-nowrap font-bold text-blue-800">${this.formatNumberWithCommas(actual_balance)}</td>
                        <td class="px-3 py-2 text-sm text-right whitespace-nowrap">${isNetted ? '-' : this.formatNumberWithCommas(row.paid_after_cutoff)}</td>
                        <td class="px-3 py-2 text-sm text-left whitespace-nowrap">${date_due}</td>
                        <td class="px-3 py-2 text-sm text-center whitespace-nowrap ${diasClass}">${row.dias_vencido || 0}</td>
                        <td class="px-3 py-2 text-sm text-center whitespace-nowrap">
                            <span class="px-2 py-1 rounded text-xs ${estadoBadge}">${row.estado_deuda || ''}</span>
                        </td>
                        <td class="px-3 py-2 text-sm text-left whitespace-nowrap">${row.antiguedad || ''}</td>
                        
                        <!-- Eliminado Condición Pago -->
                        <td class="px-3 py-2 text-sm text-left whitespace-nowrap">${payment_state}</td>
                        <!-- Eliminado Usuario Responsable -->
                    </tr>
                `;
            }).join('');
            
            tbody.insertAdjacentHTML('beforeend', html);
        },
        
        formatNumber(value) {
            const num = parseFloat(value) || 0;
            return num.toFixed(2);
        },
        
        formatNumberWithCommas(value) {
            const num = parseFloat(value) || 0;
            return num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        },
        
        formatNumberNoDec(value) {
            const num = parseFloat(value) || 0;
            return num.toLocaleString('en-US', { maximumFractionDigits: 0 });
        },
        
        async applyFilters() {
            await this.loadData();
        },
        
        resetFilters() {
            this.filters = {
                date_from: '',
                date_to: '',
                date_cutoff: '',
                supplier: '',
                account_codes_text: '421,422,423,424',
                limit: '1000',
                doc_type_id: '',
                reference: '',
                only_vouchers: true, // Por defecto activado
                include_reconciled: false
            };
            this.applyFilters();
        },
        
        async refreshData() {
            await this.loadData();
        },
        
        async exportToExcel() {
            this.loading = true;
            try {
                const params = new URLSearchParams();
                Object.keys(this.filters).forEach(key => {
                    let value = this.filters[key];
                    if (key === 'account_codes_text') {
                        value = this.getAccountCodesForAPI();
                        key = 'account_codes';
                    }
                    if (value && value !== '') {
                        params.set(key, value);
                    }
                });
                window.location.href = `/api/v1/exports/treasury/excel?${params}`;
                showToast('Exportación iniciada', 'success');
            } catch (error) {
                showToast('Error al exportar', 'error');
            } finally {
                this.loading = false;
            }
        },
        
        formatCurrency(value) {
            return window.formatCurrency(value);
        }
    }
}
</script>
{% endblock %}

{% block extra_css %}
<style>
    /* Animaciones y smooth scroll */
    .overflow-x-auto {
        scroll-behavior: smooth;
    }

    /* Loading spinner custom */
    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .animate-spin {
        animation: spin 1s linear infinite;
    }

    /* Tailwind + Bootstrap compatibility */
    .btn {
        @apply px-4 py-2 rounded font-medium transition-colors;
    }

    .btn-primary {
        @apply text-white;
        background-color: var(--primary-color);
    }

    .btn-primary:hover {
        background-color: var(--primary-hover);
    }

    .form-control {
        @apply w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-primary focus:border-transparent;
    }

    /* Truncate cell with hover expansion */
    .truncate-cell {
        max-width: 150px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        transition: all 0.2s ease;
    }
    
    .truncate-cell:hover {
        white-space: normal;
        overflow: visible;
        word-break: break-word;
        position: relative;
        z-index: 50;
        background-color: #fff;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        min-width: 200px;
        border-radius: 4px;
        padding: 4px;
        margin: -4px;
    }
    
    /* Evitar scroll horizontal en la página */
    * {
        box-sizing: border-box;
    }
    
    /* Asegurar que los contenedores no excedan el ancho de la pantalla */
    .bg-white.rounded-lg {
        max-width: 100%;
        overflow-x: hidden;
    }
    
    /* Responsive improvements */
    @media (max-width: 768px) {
        /* Ajustar grid de filtros en móvil */
        .grid.grid-cols-1.md\:grid-cols-2.lg\:grid-cols-3.xl\:grid-cols-6 {
            grid-template-columns: 1fr !important;
        }
        
        /* KPI Ribbon en móvil */
        .flex.items-stretch.divide-x {
            flex-direction: column;
        }
        
        .flex.items-stretch.divide-x > div {
            border-right: none !important;
            border-bottom: 1px solid #e5e7eb;
        }
    }
    
    /* Tablet */
    @media (min-width: 769px) and (max-width: 1024px) {
        .grid.grid-cols-1.md\:grid-cols-2.lg\:grid-cols-3.xl\:grid-cols-6 {
            grid-template-columns: repeat(2, 1fr) !important;
        }
    }
    
    /* Desktop */
    @media (min-width: 1025px) and (max-width: 1439px) {
        .grid.grid-cols-1.md\:grid-cols-2.lg\:grid-cols-3.xl\:grid-cols-6 {
            grid-template-columns: repeat(3, 1fr) !important;
        }
    }
    
    /* Desktop grande */
    @media (min-width: 1440px) {
        .grid.grid-cols-1.md\:grid-cols-2.lg\:grid-cols-3.xl\:grid-cols-6 {
            grid-template-columns: repeat(6, 1fr) !important;
        }
    }
</style>
{% endblock %}
