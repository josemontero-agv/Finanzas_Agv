{% extends "base.html" %}

{% block title %}Reporte Cuenta 42 - Tesorería{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="bi bi-file-earmark-text"></i> Reporte Cuenta 42 - Cuentas por Pagar</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <button type="button" class="btn btn-sm btn-success me-2" onclick="exportToExcel()">
            <i class="bi bi-file-earmark-excel"></i> Exportar Excel
        </button>
        <button type="button" class="btn btn-sm btn-primary" onclick="loadReport()">
            <i class="bi bi-arrow-clockwise"></i> Actualizar
        </button>
    </div>
</div>

<!-- Filtros -->
<div class="card mb-3">
    <div class="card-header">
        <i class="bi bi-funnel"></i> Filtros
    </div>
    <div class="card-body">
        <form id="filterForm">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Fecha Desde</label>
                    <input type="date" class="form-control" id="dateFrom" name="date_from">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Fecha Hasta</label>
                    <input type="date" class="form-control" id="dateTo" name="date_to">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Proveedor</label>
                    <input type="text" class="form-control" id="supplier" name="supplier" 
                           placeholder="Buscar proveedor...">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Límite</label>
                    <select class="form-select" id="limit" name="limit">
                        <option value="100">100 registros</option>
                        <option value="500">500 registros</option>
                        <option value="1000" selected>1000 registros</option>
                        <option value="5000">5000 registros</option>
                        <option value="10000">Todos</option>
                    </select>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-12">
                    <button type="button" class="btn btn-primary" onclick="loadReport()">
                        <i class="bi bi-search"></i> Buscar
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="clearFilters()">
                        <i class="bi bi-x-circle"></i> Limpiar
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Estadísticas -->
<div class="row mb-3">
    <div class="col-md-3">
        <div class="card bg-light">
            <div class="card-body">
                <h6 class="card-title text-muted">Total Registros</h6>
                <h4 id="statTotal">-</h4>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-light">
            <div class="card-body">
                <h6 class="card-title text-muted">Monto Total</h6>
                <h4 id="statAmount">-</h4>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-light">
            <div class="card-body">
                <h6 class="card-title text-muted">Saldo Pendiente</h6>
                <h4 id="statPending">-</h4>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-light">
            <div class="card-body">
                <h6 class="card-title text-muted">Deuda Vencida</h6>
                <h4 id="statOverdue">-</h4>
            </div>
        </div>
    </div>
</div>

<!-- Tabla de Datos -->
<div class="card">
    <div class="card-header">
        <i class="bi bi-table"></i> Datos del Reporte
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table id="reportTable" class="table table-striped table-hover table-sm">
                <thead class="table-dark">
                    <tr>
                        <th>Factura</th>
                        <th>Proveedor</th>
                        <th>RUC</th>
                        <th>F. Emisión</th>
                        <th>F. Vencimiento</th>
                        <th>Moneda</th>
                        <th>Monto Total</th>
                        <th>Saldo</th>
                        <th>Días Vencido</th>
                        <th>Estado</th>
                        <th>Antigüedad</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const API_BASE = '/api/v1';
    let reportData = [];

    // Cargar reporte al iniciar
    document.addEventListener('DOMContentLoaded', function() {
        loadReport();
    });

    // Función para cargar reporte
    function loadReport() {
        showLoading();
        
        const filters = {
            date_from: document.getElementById('dateFrom').value,
            date_to: document.getElementById('dateTo').value,
            supplier: document.getElementById('supplier').value,
            limit: document.getElementById('limit').value
        };

        // Construir query string
        const params = new URLSearchParams();
        Object.keys(filters).forEach(key => {
            if (filters[key]) params.append(key, filters[key]);
        });

        fetch(`${API_BASE}/treasury/report/account42?${params}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    reportData = data.data;
                    displayData(data.data);
                    updateStatistics(data.data);
                } else {
                    alert('Error al cargar datos: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al conectar con la API');
            })
            .finally(() => {
                hideLoading();
            });
    }

    // Función para mostrar datos en tabla
    function displayData(data) {
        // Destruir DataTable si existe
        if ($.fn.DataTable.isDataTable('#reportTable')) {
            $('#reportTable').DataTable().destroy();
        }

        const tbody = document.querySelector('#reportTable tbody');
        tbody.innerHTML = '';

        data.forEach(row => {
            const tr = document.createElement('tr');
            const diasClass = row.dias_vencido > 0 ? 'text-danger fw-bold' : '';
            
            tr.innerHTML = `
                <td>${row.move_name || ''}</td>
                <td>${row.supplier_name || ''}</td>
                <td>${row.supplier_vat || ''}</td>
                <td>${row.invoice_date || ''}</td>
                <td>${row.invoice_date_due || ''}</td>
                <td>${row.currency_id || ''}</td>
                <td class="text-end">${formatCurrency(row.amount_total)}</td>
                <td class="text-end">${formatCurrency(row.amount_residual)}</td>
                <td class="${diasClass} text-center">${row.dias_vencido || 0}</td>
                <td><span class="badge bg-${getStatusBadge(row.estado_deuda)}">${row.estado_deuda || ''}</span></td>
                <td><small>${row.antiguedad || ''}</small></td>
            `;
            tbody.appendChild(tr);
        });

        // Inicializar DataTable
        $('#reportTable').DataTable({
            pageLength: 25,
            order: [[8, 'desc']],  // Ordenar por días vencido
            dom: 'Bfrtip',
            buttons: []
        });
    }

    // Función para actualizar estadísticas
    function updateStatistics(data) {
        const total = data.length;
        const amountTotal = data.reduce((sum, row) => sum + (row.amount_total || 0), 0);
        const amountPending = data.reduce((sum, row) => sum + (row.amount_residual || 0), 0);
        const amountOverdue = data.reduce((sum, row) => {
            return sum + (row.dias_vencido > 0 ? (row.amount_residual || 0) : 0);
        }, 0);

        document.getElementById('statTotal').textContent = total.toLocaleString();
        document.getElementById('statAmount').textContent = formatCurrency(amountTotal);
        document.getElementById('statPending').textContent = formatCurrency(amountPending);
        document.getElementById('statOverdue').textContent = formatCurrency(amountOverdue);
    }

    // Función para limpiar filtros
    function clearFilters() {
        document.getElementById('filterForm').reset();
        loadReport();
    }

    // Función para exportar a Excel
    function exportToExcel() {
        showLoading();
        
        const filters = {
            date_from: document.getElementById('dateFrom').value,
            date_to: document.getElementById('dateTo').value,
            supplier: document.getElementById('supplier').value,
            limit: document.getElementById('limit').value
        };

        const params = new URLSearchParams();
        Object.keys(filters).forEach(key => {
            if (filters[key]) params.append(key, filters[key]);
        });

        window.location.href = `${API_BASE}/exports/treasury/excel?${params}`;
        hideLoading();
    }

    // Helpers
    function formatCurrency(amount) {
        return new Intl.NumberFormat('es-PE', { 
            style: 'currency', 
            currency: 'PEN' 
        }).format(amount || 0);
    }

    function getStatusBadge(estado) {
        return estado === 'VENCIDO' ? 'danger' : 'success';
    }
</script>
{% endblock %}

