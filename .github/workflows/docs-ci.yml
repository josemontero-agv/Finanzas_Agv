name: üîç CI - Validaci√≥n de Documentaci√≥n

on:
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'docs/**'
      - 'mkdocs.yml'
      - '.github/workflows/**'
  push:
    branches: [ main ]
    paths:
      - 'docs/**'
      - 'mkdocs.yml'

jobs:
  lint-markdown:
    name: üìù Lint Markdown Files
    runs-on: ubuntu-latest
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Instalar markdownlint-cli
        run: npm install -g markdownlint-cli

      - name: Ejecutar markdownlint
        run: markdownlint 'docs/**/*.md' --config .markdownlint.json
        continue-on-error: true

  validate-structurizr:
    name: üèóÔ∏è Validar Structurizr DSL
    runs-on: ubuntu-latest
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Descargar Structurizr CLI
        run: |
          wget https://github.com/structurizr/cli/releases/latest/download/structurizr-cli.zip
          unzip structurizr-cli.zip -d structurizr-cli

      - name: Validar DSL
        run: |
          ./structurizr-cli/structurizr.sh validate -workspace docs/c4model/workspace.dsl

  build-docs:
    name: üî® Construir Documentaci√≥n
    runs-on: ubuntu-latest
    needs: [lint-markdown, validate-structurizr]
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Instalar dependencias MkDocs
        run: |
          pip install mkdocs mkdocs-material

      - name: Construir sitio MkDocs
        run: mkdocs build --strict

      - name: Subir artefacto del sitio
        uses: actions/upload-artifact@v4
        with:
          name: docs-site
          path: site/
          retention-days: 7

  check-links:
    name: üîó Verificar Enlaces
    runs-on: ubuntu-latest
    needs: build-docs
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Instalar dependencias
        run: |
          pip install mkdocs mkdocs-material

      - name: Construir sitio
        run: mkdocs build

      - name: Instalar linkchecker
        run: pip install linkchecker

      - name: Verificar enlaces internos
        run: |
          linkchecker site/ --check-extern --ignore-url="^https?://(localhost|127\.0\.0\.1)" --no-warnings
        continue-on-error: false

  validate-cross-references:
    name: üîç Validar Referencias Cruzadas
    runs-on: ubuntu-latest
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Verificar que ADRs referencian componentes C4
        run: |
          echo "üîç Verificando que ADRs contengan referencias a arquitectura..."
          
          # Verificar que al menos un ADR mencione el modelo C4
          if ! grep -r "C4\|componente\|arquitectura" docs/adrs/*.md; then
            echo "‚ö†Ô∏è Advertencia: No se encontraron referencias a arquitectura en ADRs"
          fi
          
          # Verificar que Runbooks referencien ADRs
          if ! grep -r "ADR-\|decisi√≥n" docs/runbooks/*.md; then
            echo "‚ö†Ô∏è Advertencia: No se encontraron referencias a ADRs en Runbooks"
          fi
          
          echo "‚úÖ Verificaci√≥n de referencias cruzadas completada"

